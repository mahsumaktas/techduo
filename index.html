<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>‚ö° TechDuo</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  :root{
    --bg:#0f172a;
    --card:#1e293b;
    --card2:#263247;
    --blue:#38bdf8;
    --green:#22c55e;
    --yellow:#fbbf24;
    --red:#f43f5e;
    --purple:#a78bfa;
    --text:#e2e8f0;
    --muted:#94a3b8;
    --border:#334155;
    --radius:14px;
  }
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;font-size:16px;line-height:1.5}
  #app{max-width:600px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding-bottom:20px}

  /* HEADER */
  .header{display:flex;align-items:center;gap:8px;padding:12px 14px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
  .header-logo{font-size:20px;font-weight:900;color:var(--blue);display:flex;align-items:center;gap:6px;flex:1}
  .header-logo img{width:28px;height:28px;object-fit:contain;border-radius:50%;transition:transform .2s,filter .2s}
  .header-stats{display:flex;align-items:center;gap:6px}
  .stat-badge{display:flex;align-items:center;gap:4px;font-size:13px;font-weight:700;background:var(--card2);padding:4px 9px;border-radius:20px}
  .stat-xp{color:var(--yellow)}
  .stat-streak{color:#fb923c}
  .stat-lives{color:var(--red)}
  .level-badge{font-size:13px;background:var(--card2);padding:4px 9px;border-radius:20px;cursor:pointer;transition:transform .15s}
  .level-badge:hover{transform:scale(1.05)}
  .sound-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:4px;opacity:.7;transition:opacity .15s}
  .sound-btn:hover{opacity:1}

  /* SCREENS */
  .screen{flex:1;padding:16px;display:none}
  .screen.active{display:block}

  /* DAILY GOAL */
  .daily-goal-bar{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-bottom:14px}
  .daily-goal-header{display:flex;justify-content:space-between;font-size:12px;font-weight:700;margin-bottom:8px;color:var(--muted)}
  .daily-goal-track{height:8px;background:var(--border);border-radius:4px;overflow:hidden}
  .daily-goal-fill{height:100%;background:var(--blue);border-radius:4px;transition:width .5s}
  .daily-goal-fill.complete{background:var(--green)}

  /* UNIT CARDS */
  .unit-list{display:flex;flex-direction:column;gap:12px}
  .unit-card{background:var(--card);border:2px solid var(--border);border-radius:var(--radius);padding:15px;cursor:pointer;transition:transform .15s,border-color .15s;position:relative;overflow:hidden}
  .unit-card:hover{transform:translateY(-2px)}
  .unit-card.active-unit{border-color:var(--blue);box-shadow:0 0 0 3px rgba(56,189,248,.15)}
  .unit-card.completed-unit{border-color:var(--green)}
  .unit-card.locked-unit{opacity:.5;cursor:not-allowed}
  .unit-card-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .unit-emoji{font-size:24px}
  .unit-info{flex:1}
  .unit-title{font-size:15px;font-weight:700}
  .unit-desc{font-size:12px;color:var(--muted);margin-top:2px}
  .unit-badge{font-size:18px;margin-left:4px}
  .unit-meta{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
  .unit-topics-count{font-size:11px;color:var(--muted)}
  .unit-progress-bar{height:5px;background:var(--border);border-radius:4px;flex:1;margin:0 8px;overflow:hidden}
  .unit-progress-fill{height:100%;background:var(--blue);border-radius:4px;transition:width .5s}
  .unit-progress-fill.done{background:var(--green)}
  .unit-pct{font-size:11px;font-weight:700;color:var(--muted)}
  .unit-btn{background:var(--blue);color:#0f172a;font-weight:700;border:none;border-radius:8px;padding:7px 14px;font-size:13px;cursor:pointer;margin-top:10px;width:100%}
  .unit-btn:hover{filter:brightness(1.1)}
  .emoji-unit-img{width:38px;height:38px;object-fit:contain}

  /* PLACEMENT TEST BANNER */
  .placement-banner{background:linear-gradient(135deg,rgba(167,139,250,.15),rgba(56,189,248,.1));border:1px solid rgba(167,139,250,.3);border-radius:var(--radius);padding:12px 14px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .15s}
  .placement-banner:hover{border-color:var(--purple)}
  .placement-banner-text{font-size:13px;font-weight:700;color:var(--purple)}
  .placement-banner-sub{font-size:11px;color:var(--muted);margin-top:2px}
  .placement-banner-arrow{font-size:20px;color:var(--purple)}

  /* TOPICS SCREEN */
  .back-btn{display:flex;align-items:center;gap:6px;color:var(--blue);background:none;border:none;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:14px;padding:4px 0}
  .back-btn:hover{text-decoration:underline}
  .screen-title{font-size:20px;font-weight:800;margin-bottom:16px}
  .topics-roadmap{display:flex;flex-direction:column;gap:0}
  .topic-node{display:flex;align-items:stretch;gap:0}
  .topic-connector{display:flex;flex-direction:column;align-items:center;width:44px;flex-shrink:0}
  .topic-dot{width:36px;height:36px;border-radius:50%;border:3px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:16px;background:var(--card);flex-shrink:0;z-index:1}
  .topic-dot.done{background:var(--green);border-color:var(--green)}
  .topic-dot.current{background:var(--blue);border-color:var(--blue);box-shadow:0 0 0 4px rgba(56,189,248,.2)}
  .topic-line{flex:1;width:3px;background:var(--border);margin:0 auto}
  .topic-line.done{background:var(--green)}
  .topic-content{flex:1;padding:0 0 20px 12px}
  .topic-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:13px;cursor:pointer;transition:border-color .15s}
  .topic-card:hover{border-color:var(--blue)}
  .topic-card.done{border-color:rgba(34,197,94,.4)}
  .topic-card-title{font-size:15px;font-weight:700}
  .topic-card-meta{font-size:12px;color:var(--muted);margin-top:3px}
  .topic-card-status{font-size:12px;color:var(--green);font-weight:600;margin-top:3px}

  /* QUESTION SCREEN */
  .q-header{display:flex;align-items:center;gap:10px;margin-bottom:20px}
  .q-progress{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
  .q-progress-fill{height:100%;background:var(--blue);border-radius:4px;transition:width .4s}
  .q-count{font-size:12px;color:var(--muted);white-space:nowrap}
  .q-lives{font-size:14px}
  .q-type-badge{font-size:11px;font-weight:700;letter-spacing:.5px;color:var(--muted);text-transform:uppercase;margin-bottom:10px}
  .q-question{font-size:18px;font-weight:700;margin-bottom:22px;line-height:1.4}
  .q-options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
  .q-option{background:var(--card);border:2px solid var(--border);border-radius:var(--radius);padding:13px 12px;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;text-align:left;color:var(--text)}
  .q-option:hover:not(:disabled){border-color:var(--blue);background:rgba(56,189,248,.1)}
  .q-option.selected{border-color:var(--blue);background:rgba(56,189,248,.15)}
  .q-option.correct{border-color:var(--green)!important;background:rgba(34,197,94,.15)!important;color:var(--green)}
  .q-option.wrong{border-color:var(--red)!important;background:rgba(244,63,94,.15)!important;color:var(--red)}
  .q-option:disabled{cursor:not-allowed}
  .q-tf-options{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
  .q-tf-btn{background:var(--card);border:2px solid var(--border);border-radius:var(--radius);padding:18px;font-size:20px;cursor:pointer;text-align:center;transition:all .15s;color:var(--text)}
  .q-tf-btn:hover:not(:disabled){transform:scale(1.03)}
  .q-tf-btn.selected{border-color:var(--blue);background:rgba(56,189,248,.15)}
  .q-tf-btn.correct{border-color:var(--green)!important;background:rgba(34,197,94,.15)!important}
  .q-tf-btn.wrong{border-color:var(--red)!important;background:rgba(244,63,94,.15)!important}
  .q-tf-btn:disabled{cursor:not-allowed}
  .q-fill-wrap{margin-bottom:20px}
  .q-fill-template{font-size:16px;line-height:1.8;margin-bottom:12px;background:var(--card);padding:14px;border-radius:10px}
  .q-fill-template span{color:var(--blue);font-weight:700;border-bottom:2px dashed var(--blue)}
  .q-fill-input{width:100%;background:var(--card2);border:2px solid var(--border);border-radius:10px;padding:12px;font-size:16px;color:var(--text);outline:none;transition:border-color .15s}
  .q-fill-input:focus{border-color:var(--blue)}
  .q-fill-input.correct{border-color:var(--green)}
  .q-fill-input.wrong{border-color:var(--red)}
  .q-check-btn{width:100%;background:var(--blue);color:#0f172a;font-weight:800;font-size:16px;border:none;border-radius:12px;padding:15px;cursor:pointer;transition:all .15s}
  .q-check-btn:hover:not(:disabled){filter:brightness(1.1)}
  .q-check-btn:disabled{opacity:.5;cursor:not-allowed}
  .q-feedback{border-radius:var(--radius);padding:14px;margin-top:14px;margin-bottom:10px}
  .q-feedback.correct-fb{background:rgba(34,197,94,.15);border:1px solid var(--green)}
  .q-feedback.wrong-fb{background:rgba(244,63,94,.15);border:1px solid var(--red)}
  .q-feedback-title{font-weight:800;font-size:15px;margin-bottom:4px}
  .q-feedback-title.c{color:var(--green)}
  .q-feedback-title.w{color:var(--red)}
  .q-feedback-exp{font-size:13px;color:var(--muted);line-height:1.5}
  .q-continue-btn{width:100%;background:var(--green);color:#fff;font-weight:800;font-size:16px;border:none;border-radius:12px;padding:15px;cursor:pointer;margin-top:8px;transition:all .15s}
  .q-continue-btn:hover{filter:brightness(1.1)}
  .q-xp-flash{position:fixed;top:70px;right:16px;background:var(--yellow);color:#0f172a;font-weight:800;border-radius:20px;padding:6px 14px;font-size:14px;animation:flashUp .9s forwards;pointer-events:none;z-index:999}
  @keyframes flashUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-40px)}}

  /* COMBO BADGE */
  .combo-badge{display:inline-block;background:linear-gradient(135deg,#fb923c,#f43f5e);color:#fff;font-weight:900;font-size:12px;padding:3px 10px;border-radius:20px;margin-left:8px;animation:comboPop .3s ease}
  @keyframes comboPop{0%{transform:scale(0.5)}70%{transform:scale(1.2)}100%{transform:scale(1)}}

  /* COMPLETION SCREEN */
  .completion{text-align:center;padding:40px 16px}
  .completion-icon{font-size:72px;margin-bottom:16px;animation:pop .5s cubic-bezier(.36,.07,.19,.97)}
  @keyframes pop{0%{transform:scale(0)}70%{transform:scale(1.2)}100%{transform:scale(1)}}
  .completion-title{font-size:28px;font-weight:900;margin-bottom:8px}
  .completion-sub{color:var(--muted);font-size:15px;margin-bottom:20px}
  .completion-xp{background:var(--card);border:2px solid var(--yellow);border-radius:16px;padding:18px;margin-bottom:16px;display:inline-block;min-width:200px}
  .completion-xp-label{font-size:12px;color:var(--muted);margin-bottom:4px}
  .completion-xp-val{font-size:36px;font-weight:900;color:var(--yellow)}
  .completion-level{font-size:13px;color:var(--muted);margin-bottom:20px}
  .completion-btn{background:var(--blue);color:#0f172a;font-weight:800;font-size:17px;border:none;border-radius:14px;padding:17px 40px;cursor:pointer;width:100%;max-width:320px;display:block;margin:0 auto}
  .completion-btn:hover{filter:brightness(1.1)}
  .share-btn{background:#1da1f2;color:#fff;font-weight:700;font-size:14px;border:none;border-radius:12px;padding:12px 24px;cursor:pointer;margin-top:10px;width:100%;max-width:320px;display:block;margin:10px auto 0}
  .share-btn:hover{filter:brightness(1.1)}

  /* NO LIVES SCREEN */
  .no-lives{text-align:center;padding:60px 16px}
  .no-lives-icon{font-size:72px;margin-bottom:20px}
  .no-lives-title{font-size:26px;font-weight:900;margin-bottom:10px}
  .no-lives-sub{color:var(--muted);margin-bottom:30px;font-size:15px}
  .no-lives-btn{background:var(--red);color:#fff;font-weight:800;font-size:16px;border:none;border-radius:12px;padding:15px 30px;cursor:pointer;margin:6px auto;width:80%;max-width:280px;display:block}

  /* PLACEMENT SCREEN */
  .placement-wrap{padding:8px 0}
  .placement-header{font-size:22px;font-weight:900;margin-bottom:6px}
  .placement-sub{font-size:14px;color:var(--muted);margin-bottom:20px;line-height:1.5}
  .placement-result{text-align:center;padding:30px 0}
  .placement-result-icon{font-size:64px;margin-bottom:14px}
  .placement-result-title{font-size:22px;font-weight:900;margin-bottom:8px}
  .placement-result-sub{font-size:14px;color:var(--muted);margin-bottom:24px;line-height:1.5}
  .placement-result-btn{background:var(--blue);color:#0f172a;font-weight:800;font-size:16px;border:none;border-radius:12px;padding:15px 30px;cursor:pointer;width:100%;max-width:280px}

  /* ACHIEVEMENTS POPUP */
  .achievement-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--card2),var(--card));border:2px solid var(--yellow);border-radius:14px;padding:12px 20px;font-size:14px;font-weight:700;z-index:9999;animation:achIn .4s ease;text-align:center;min-width:200px;box-shadow:0 8px 30px rgba(0,0,0,.4)}
  @keyframes achIn{0%{opacity:0;transform:translateX(-50%) scale(0.7)}70%{transform:translateX(-50%) scale(1.05)}100%{opacity:1;transform:translateX(-50%) scale(1)}}
  .achievement-toast .ach-label{color:var(--yellow);font-size:12px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}

  /* LEVEL UP */
  .levelup-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9998;animation:fadeIn .3s ease}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .levelup-card{background:var(--card);border:3px solid var(--yellow);border-radius:20px;padding:32px;text-align:center;max-width:300px;width:90%;animation:pop .4s cubic-bezier(.36,.07,.19,.97)}
  .levelup-emoji{font-size:56px;margin-bottom:12px}
  .levelup-title{font-size:24px;font-weight:900;color:var(--yellow);margin-bottom:8px}
  .levelup-sub{font-size:14px;color:var(--muted);margin-bottom:20px}
  .levelup-btn{background:var(--yellow);color:#0f172a;font-weight:800;border:none;border-radius:10px;padding:12px 28px;font-size:15px;cursor:pointer}

  /* TOAST */
  .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 20px;font-size:14px;font-weight:600;z-index:999;animation:toastIn .3s ease;white-space:nowrap;max-width:90vw}
  @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

  /* ANIMATIONS */
  @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
  .shaking{animation:shake 0.4s ease}
  @keyframes xpPulse{0%{transform:scale(1)}50%{transform:scale(1.5)}100%{transform:scale(1)}}
  .xp-pulse{animation:xpPulse 0.3s ease}
  .confetti-piece{position:fixed;top:-12px;border-radius:3px;animation:confettiFall linear forwards;pointer-events:none;z-index:9997}
  @keyframes confettiFall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}

  /* STATS SCREEN */
  .stats-wrap{padding:8px 0}
  .stats-header{font-size:22px;font-weight:900;margin-bottom:20px;display:flex;align-items:center;gap:8px}
  .stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
  .stat-card-label{font-size:12px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
  .stat-card-val{font-size:28px;font-weight:900}
  .stat-card-val.yellow{color:var(--yellow)}
  .stat-card-val.green{color:var(--green)}
  .stat-card-val.blue{color:var(--blue)}
  .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  .achievements-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .ach-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;transition:all .2s}
  .ach-card.unlocked{border-color:var(--yellow);background:rgba(251,191,36,.05)}
  .ach-card-icon{font-size:24px;margin-bottom:4px;opacity:.4}
  .ach-card.unlocked .ach-card-icon{opacity:1}
  .ach-card-label{font-size:11px;color:var(--muted);font-weight:600}
  .ach-card.unlocked .ach-card-label{color:var(--text)}

  .mt8{margin-top:8px}
  .flex-center{display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<div id="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-logo">
      <img src="assets/mascot.png" id="mascot-img" alt="TechDuo" onerror="this.style.display='none'">
      ‚ö° TechDuo
    </div>
    <div class="header-stats">
      <div class="stat-badge level-badge" id="level-badge" onclick="showStats()" title="ƒ∞statistikler">üå±</div>
      <div class="stat-badge stat-xp">‚≠ê <span id="xp-display">0</span></div>
      <div class="stat-badge stat-streak">üî• <span id="streak-display">0</span></div>
      <div class="stat-badge stat-lives">‚ù§Ô∏è <span id="lives-display">5</span></div>
      <button class="sound-btn" id="sound-btn" onclick="toggleSound()" title="Ses">üîä</button>
    </div>
  </header>

  <!-- HOME SCREEN -->
  <div class="screen active" id="screen-home">
    <div id="daily-goal-container"></div>
    <div class="placement-banner" onclick="startPlacementTest()" id="placement-banner">
      <div>
        <div class="placement-banner-text">üéØ Seviyeni Test Et</div>
        <div class="placement-banner-sub">Bilgini √∂l√ß, doƒüru yerden ba≈üla</div>
      </div>
      <div class="placement-banner-arrow">‚Üí</div>
    </div>
    <div class="unit-list" id="unit-list"></div>
  </div>

  <!-- TOPICS SCREEN -->
  <div class="screen" id="screen-topics">
    <button class="back-btn" onclick="showHome()">‚Üê Geri</button>
    <div class="screen-title" id="topics-unit-title">√únite</div>
    <div class="topics-roadmap" id="topics-roadmap"></div>
  </div>

  <!-- QUESTION SCREEN -->
  <div class="screen" id="screen-question">
    <div class="q-header">
      <button class="back-btn" style="margin:0;font-size:18px;" onclick="exitQuestion()">‚úï</button>
      <div class="q-progress"><div class="q-progress-fill" id="q-progress-fill"></div></div>
      <div class="q-count" id="q-count">1/5</div>
      <div class="q-lives" id="q-lives-disp">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    <div id="q-body"></div>
  </div>

  <!-- PLACEMENT TEST SCREEN -->
  <div class="screen" id="screen-placement">
    <button class="back-btn" onclick="showHome()">‚Üê Geri</button>
    <div class="placement-wrap">
      <div class="placement-header">üéØ Seviye Testi</div>
      <div class="placement-sub">10 hƒ±zlƒ± soru ile seviyeni belirle. Cevaplamak zorunda deƒüilsin ‚Äî ge√ß de diyebilirsin!</div>
      <div id="placement-body"></div>
    </div>
  </div>

  <!-- STATS SCREEN -->
  <div class="screen" id="screen-stats">
    <button class="back-btn" onclick="showHome()">‚Üê Ana Sayfa</button>
    <div class="stats-wrap">
      <div class="stats-header">üìä ƒ∞statistikler</div>
      <div id="stats-body"></div>
    </div>
  </div>

  <!-- COMPLETION SCREEN -->
  <div class="screen" id="screen-completion">
    <div class="completion">
      <div class="completion-icon">üèÜ</div>
      <div class="completion-title" id="comp-title">Konu Tamamlandƒ±!</div>
      <div class="completion-sub" id="comp-sub">Harika i≈ü √ßƒ±kardƒ±n!</div>
      <div class="completion-xp">
        <div class="completion-xp-label">Kazanƒ±lan XP</div>
        <div class="completion-xp-val" id="comp-xp">+35</div>
      </div>
      <div class="completion-level" id="comp-level"></div>
      <button class="completion-btn" onclick="afterCompletion()">Devam Et ‚Üí</button>
      <button class="share-btn" onclick="shareTwitter()">üê¶ X'te Payla≈ü</button>
    </div>
  </div>

  <!-- NO LIVES SCREEN -->
  <div class="screen" id="screen-nolives">
    <div class="no-lives">
      <div class="no-lives-icon">ü´Ä</div>
      <div class="no-lives-title">Canlar T√ºkendi!</div>
      <div class="no-lives-sub">Biraz dinlen, sonra tekrar dene. Canlarƒ±n zamanla yenileniyor!</div>
      <button class="no-lives-btn" onclick="refillLives()">üíñ Canlarƒ± Yenile (Pratik Mod)</button>
      <button class="no-lives-btn" style="background:var(--card);color:var(--text);border:2px solid var(--border);margin-top:6px;" onclick="showHome()">üè† Ana Sayfaya D√∂n</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// SOUND SYSTEM (Web Audio API)
// ============================================================
let audioCtx = null;
function getAudio(){
  if(!audioCtx){
    try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
  }
  return audioCtx;
}
function playTone(freq, dur, type='sine', vol=0.25){
  try{
    const ctx = getAudio(); if(!ctx) return;
    if(ctx.state==='suspended') ctx.resume();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = freq; o.type = type;
    g.gain.setValueAtTime(vol, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    o.start(); o.stop(ctx.currentTime + dur);
  }catch(e){}
}
function playCorrect(){
  if(!state.soundEnabled) return;
  playTone(880, 0.12); setTimeout(()=>playTone(1100, 0.1), 130);
}
function playWrong(){
  if(!state.soundEnabled) return;
  playTone(200, 0.35, 'sawtooth', 0.18);
}
function playComboSound(){
  if(!state.soundEnabled) return;
  [400,600,900].forEach((f,i)=>setTimeout(()=>playTone(f,0.1),i*70));
}
function playComplete(){
  if(!state.soundEnabled) return;
  [523,659,784,1047].forEach((f,i)=>setTimeout(()=>playTone(f,0.18),i*110));
}
function toggleSound(){
  state.soundEnabled = !state.soundEnabled;
  document.getElementById('sound-btn').textContent = state.soundEnabled ? 'üîä' : 'üîá';
  saveState();
}

// ============================================================
// LEVEL SYSTEM
// ============================================================
const LEVELS = [
  {min:0,    label:'√áaylak',   emoji:'üå±', next:100},
  {min:100,  label:'√ñƒürenci',  emoji:'üìö', next:300},
  {min:300,  label:'Uzman',    emoji:'üí°', next:700},
  {min:700,  label:'M√ºhendis', emoji:'‚öôÔ∏è', next:1500},
  {min:1500, label:'Usta',     emoji:'üèÜ', next:3000},
  {min:3000, label:'Efsane',   emoji:'üåü', next:Infinity},
];
function getLevelInfo(xp){
  return [...LEVELS].reverse().find(l=>xp>=l.min) || LEVELS[0];
}

// ============================================================
// ACHIEVEMENTS
// ============================================================
const ACHIEVEMENTS = [
  {id:'first_correct', icon:'üéØ', label:'ƒ∞lk Adƒ±m',    desc:'ƒ∞lk doƒüru cevap'},
  {id:'streak_3',      icon:'üî•', label:'Ate≈üli',      desc:'3 ardƒ±≈üƒ±k doƒüru'},
  {id:'xp_100',        icon:'üíØ', label:'Y√ºzl√ºk',      desc:'100 XP kazan'},
  {id:'xp_500',        icon:'üí™', label:'G√º√ßleniyorum', desc:'500 XP kazan'},
  {id:'first_unit',    icon:'üéä', label:'√únite Ustasƒ±', desc:'ƒ∞lk √ºniteyi bitir'},
  {id:'perfect_topic', icon:'‚ú®', label:'M√ºkemmel',     desc:'Sƒ±fƒ±r hatayla konu bitir'},
  {id:'no_mistakes',   icon:'üõ°Ô∏è', label:'Demir Kalkan', desc:'Can kaybetmeden konu bitir'},
  {id:'all_units',     icon:'üåü', label:'Tam Tur',      desc:'T√ºm √ºniteleri tamamla'},
];
let sessionErrors = 0;

function checkAchievements(extra={}){
  ACHIEVEMENTS.forEach(a=>{
    if(state.achievements.includes(a.id)) return;
    let unlock = false;
    if(a.id==='first_correct' && state.xp>=10) unlock=true;
    if(a.id==='streak_3' && (extra.combo||0)>=3) unlock=true;
    if(a.id==='xp_100' && state.xp>=100) unlock=true;
    if(a.id==='xp_500' && state.xp>=500) unlock=true;
    if(a.id==='first_unit' && state.completedUnits.length>=1) unlock=true;
    if(a.id==='perfect_topic' && extra.perfect) unlock=true;
    if(a.id==='no_mistakes' && extra.noMistakes) unlock=true;
    if(a.id==='all_units' && CURRICULUM && state.completedUnits.length>=CURRICULUM.units.length) unlock=true;
    if(unlock){
      state.achievements.push(a.id);
      showAchievement(a);
      saveState();
    }
  });
}

function showAchievement(a){
  const el = document.createElement('div');
  el.className = 'achievement-toast';
  el.innerHTML = `<div class="ach-label">üèÜ Ba≈üarƒ± A√ßƒ±ldƒ±!</div><div style="font-size:22px;margin:4px 0">${a.icon}</div><div>${a.label}</div>`;
  document.body.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .4s'; setTimeout(()=>el.remove(),400); }, 2800);
}

// ============================================================
// STATE
// ============================================================
const DEFAULT_STATE = {
  xp:0, streak:0, lives:5,
  completedTopics:[], completedUnits:[],
  soundEnabled:true, currentCombo:0,
  achievements:[], dailyGoal:{date:'',xp:0},
  lastLevel:'√áaylak'
};
let state = {};

function loadState(){
  try{ state = JSON.parse(localStorage.getItem('techduo_state')||'{}'); }catch(e){}
  state = Object.assign({},DEFAULT_STATE,state);
  // Reset daily goal if new day
  const today = new Date().toISOString().split('T')[0];
  if(state.dailyGoal.date !== today){
    state.dailyGoal = {date:today, xp:0};
  }
}

function saveState(){
  localStorage.setItem('techduo_state', JSON.stringify(state));
  updateHeader();
}

function updateHeader(){
  // XP pulse
  const xpEl = document.getElementById('xp-display');
  if(xpEl){
    const prev = parseInt(xpEl.textContent)||0;
    xpEl.textContent = state.xp;
    if(state.xp !== prev){ xpEl.classList.remove('xp-pulse'); void xpEl.offsetWidth; xpEl.classList.add('xp-pulse'); }
  }
  const sel = id => { const el=document.getElementById(id); if(el) el.textContent=state[id.replace('-display','').replace('_display','')]; };
  const streakEl = document.getElementById('streak-display');
  if(streakEl) streakEl.textContent = state.streak;
  const livesEl = document.getElementById('lives-display');
  if(livesEl) livesEl.textContent = state.lives;

  // Level badge
  const lvl = getLevelInfo(state.xp);
  const badge = document.getElementById('level-badge');
  if(badge) badge.textContent = lvl.emoji+' '+lvl.label;

  // Level up check
  if(state.lastLevel && state.lastLevel !== lvl.label && state.xp > 0){
    showLevelUp(lvl);
  }
  state.lastLevel = lvl.label;

  // Sound btn
  const sBtn = document.getElementById('sound-btn');
  if(sBtn) sBtn.textContent = state.soundEnabled ? 'üîä' : 'üîá';
}

function showLevelUp(lvl){
  const overlay = document.createElement('div');
  overlay.className='levelup-overlay';
  overlay.innerHTML=`
    <div class="levelup-card">
      <div class="levelup-emoji">${lvl.emoji}</div>
      <div class="levelup-title">Seviye Atladƒ±n!</div>
      <div class="levelup-sub">Artƒ±k <strong>${lvl.label}</strong> seviyesindesin üéâ</div>
      <button class="levelup-btn" onclick="this.closest('.levelup-overlay').remove()">Harika! ‚Üí</button>
    </div>
  `;
  document.body.appendChild(overlay);
  playComplete();
}

// ============================================================
// DAILY GOAL
// ============================================================
function renderDailyGoal(){
  const container = document.getElementById('daily-goal-container');
  if(!container) return;
  const goal = state.dailyGoal;
  const pct = Math.min(100, Math.round((goal.xp/50)*100));
  const done = pct >= 100;
  container.innerHTML = `
    <div class="daily-goal-bar">
      <div class="daily-goal-header">
        <span>üìÖ G√ºnl√ºk Hedef</span>
        <span style="color:${done?'var(--green)':'inherit'}">${done?'‚úÖ Tamamlandƒ±!':goal.xp+'/50 XP'}</span>
      </div>
      <div class="daily-goal-track">
        <div class="daily-goal-fill${done?' complete':''}" style="width:${pct}%"></div>
      </div>
    </div>
  `;
}

// ============================================================
// CURRICULUM
// ============================================================
let CURRICULUM = null;

// ============================================================
// NAVIGATION
// ============================================================
let currentUnitId = null;
let currentTopicId = null;
let currentStops = [];
let currentStopIndex = 0;
let sessionXP = 0;
let selectedAnswer = null;
let answered = false;

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById('screen-'+id);
  if(el) el.classList.add('active');
  window.scrollTo(0,0);
}

function showHome(){
  renderHome();
  showScreen('home');
}

function showTopics(unitId){
  currentUnitId = unitId;
  renderTopics(unitId);
  showScreen('topics');
}

function showStats(){
  renderStats();
  showScreen('stats');
}

function startTopic(unitId, topicId){
  if(state.lives<=0){ showScreen('nolives'); return; }
  currentUnitId = unitId;
  currentTopicId = topicId;
  const unit = CURRICULUM.units.find(u=>u.id===unitId);
  const topic = unit.topics.find(t=>t.id===topicId);
  currentStops = topic.stops;
  currentStopIndex = 0;
  sessionXP = 0;
  sessionErrors = 0;
  selectedAnswer = null;
  answered = false;
  state.currentCombo = 0;
  renderQuestion();
  showScreen('question');
}

function exitQuestion(){
  if(currentUnitId) showTopics(currentUnitId);
  else showHome();
}

function afterCompletion(){
  const unit = CURRICULUM.units.find(u=>u.id===currentUnitId);
  if(!unit) return showHome();
  const idx = unit.topics.findIndex(t=>t.id===currentTopicId);
  if(idx>=0 && idx<unit.topics.length-1){
    showTopics(currentUnitId);
  } else {
    showHome();
  }
}

// ============================================================
// RENDER HOME
// ============================================================
function renderHome(){
  if(!CURRICULUM) return;
  updateHeader();
  renderDailyGoal();

  // Hide placement banner if all units done
  const pb = document.getElementById('placement-banner');
  if(pb) pb.style.display = state.completedUnits.length>0 ? 'none' : 'flex';

  const list = document.getElementById('unit-list');
  list.innerHTML='';
  const units = CURRICULUM.units;

  const unitImgs = {
    unit1_binary:    'assets/unit-binary.png',
    unit3_internet:  'assets/unit-internet.png',
    unit5_python:    'assets/unit-python.png',
    unit7_webdev:    'assets/unit-web.png',
    unit8_ai:        'assets/unit-ai.png',
  };

  units.forEach((unit,ui)=>{
    const topics = unit.topics||[];
    const totalTopics = topics.length;
    const doneTopic = topics.filter(t=>state.completedTopics.includes(t.id)).length;
    const pct = totalTopics>0 ? Math.round((doneTopic/totalTopics)*100) : 0;
    const isDone = state.completedUnits.includes(unit.id);
    const prevDone = ui===0 || state.completedUnits.includes(units[ui-1].id);
    const isLocked = ui>0 && !prevDone;
    const isActive = !isLocked && !isDone;

    const card = document.createElement('div');
    card.className = 'unit-card'+(isDone?' completed-unit':isLocked?' locked-unit':' active-unit');

    const imgSrc = unitImgs[unit.id];
    card.innerHTML=`
      <div class="unit-card-header">
        <div class="unit-emoji">${unit.emoji||'üìö'}</div>
        <div class="unit-info">
          <div class="unit-title">${unit.title} <span class="unit-badge">${isDone?'‚úÖ':isLocked?'üîí':''}</span></div>
          <div class="unit-desc">${unit.description||''}</div>
        </div>
        ${imgSrc?`<img src="${imgSrc}" class="emoji-unit-img" alt="" onerror="this.style.display='none'">`:''}
      </div>
      <div class="unit-meta">
        <span class="unit-topics-count">${totalTopics} konu</span>
        <div class="unit-progress-bar"><div class="unit-progress-fill${isDone?' done':''}" style="width:${pct}%"></div></div>
        <span class="unit-pct">${pct}%</span>
      </div>
      ${isActive?`<button class="unit-btn" onclick="showTopics('${unit.id}')">Ba≈üla ‚Üí</button>`:''}
      ${isDone?`<button class="unit-btn" style="background:var(--green)" onclick="showTopics('${unit.id}')">Tekrar Et ‚úÖ</button>`:''}
    `;
    if(!isLocked){
      card.style.cursor='pointer';
      card.addEventListener('click',(e)=>{
        if(e.target.tagName==='BUTTON') return;
        showTopics(unit.id);
      });
    }
    list.appendChild(card);
  });
}

// ============================================================
// RENDER TOPICS
// ============================================================
function renderTopics(unitId){
  const unit = CURRICULUM.units.find(u=>u.id===unitId);
  if(!unit) return;
  document.getElementById('topics-unit-title').textContent = unit.emoji+' '+unit.title;
  const roadmap = document.getElementById('topics-roadmap');
  roadmap.innerHTML='';
  const topics = unit.topics||[];

  topics.forEach((topic,ti)=>{
    const isDone = state.completedTopics.includes(topic.id);
    const prevDone = ti===0 || state.completedTopics.includes(topics[ti-1].id);
    const isCurrent = !isDone && prevDone;
    const isLast = ti===topics.length-1;
    const stopCount = topic.stops ? topic.stops.length : 0;

    const node = document.createElement('div');
    node.className='topic-node';
    node.innerHTML=`
      <div class="topic-connector">
        <div class="topic-dot${isDone?' done':isCurrent?' current':''}">
          ${isDone?'‚úì':isCurrent?'‚ñ∂':ti+1}
        </div>
        ${!isLast?`<div class="topic-line ${isDone?'done':''}"></div>`:''}
      </div>
      <div class="topic-content">
        <div class="topic-card${isDone?' done':''}" onclick="${isCurrent||isDone?`startTopic('${unitId}','${topic.id}')`:''}" style="${!isCurrent&&!isDone?'opacity:.5;cursor:not-allowed':''}">
          <div class="topic-card-title">${topic.title}</div>
          <div class="topic-card-meta">${stopCount} soru</div>
          ${isDone?`<div class="topic-card-status">‚úÖ Tamamlandƒ±</div>`:isCurrent?`<div class="topic-card-status" style="color:var(--blue)">‚ñ∂ Ba≈üla</div>`:''}
        </div>
      </div>
    `;
    roadmap.appendChild(node);
  });
}

// ============================================================
// STATS SCREEN
// ============================================================
function renderStats(){
  const lvl = getLevelInfo(state.xp);
  const totalTopics = CURRICULUM ? CURRICULUM.units.reduce((s,u)=>s+(u.topics?.length||0),0) : 0;
  const totalUnits = CURRICULUM ? CURRICULUM.units.length : 0;
  const nextXP = lvl.next === Infinity ? '‚àû' : lvl.next;
  const body = document.getElementById('stats-body');
  body.innerHTML = `
    <div class="stat-card" style="text-align:center;border-color:var(--yellow)">
      <div style="font-size:42px;margin-bottom:6px">${lvl.emoji}</div>
      <div style="font-size:22px;font-weight:900;color:var(--yellow)">${lvl.label}</div>
      <div style="font-size:13px;color:var(--muted);margin-top:4px">Sonraki seviye: ${nextXP} XP</div>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-card-label">Toplam XP</div><div class="stat-card-val yellow">${state.xp}</div></div>
      <div class="stat-card"><div class="stat-card-label">Seri</div><div class="stat-card-val" style="color:#fb923c">üî•${state.streak}</div></div>
      <div class="stat-card"><div class="stat-card-label">Tamamlanan Konu</div><div class="stat-card-val green">${state.completedTopics.length}/${totalTopics}</div></div>
      <div class="stat-card"><div class="stat-card-label">Tamamlanan √únite</div><div class="stat-card-val blue">${state.completedUnits.length}/${totalUnits}</div></div>
    </div>
    <div class="stat-card" style="margin-bottom:16px">
      <div class="stat-card-label" style="margin-bottom:10px">Ba≈üarƒ±lar (${state.achievements.length}/${ACHIEVEMENTS.length})</div>
      <div class="achievements-grid">
        ${ACHIEVEMENTS.map(a=>{
          const unlocked = state.achievements.includes(a.id);
          return `<div class="ach-card${unlocked?' unlocked':''}">
            <div class="ach-card-icon">${a.icon}</div>
            <div class="ach-card-label">${a.label}</div>
          </div>`;
        }).join('')}
      </div>
    </div>
    <button onclick="showHome()" style="background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:12px;width:100%;color:var(--text);font-weight:700;cursor:pointer;font-size:14px">üè† Ana Sayfaya D√∂n</button>
  `;
}

// ============================================================
// RENDER QUESTION
// ============================================================
function renderQuestion(){
  const stop = currentStops[currentStopIndex];
  if(!stop) return;
  selectedAnswer = null;
  answered = false;

  const pct = Math.round((currentStopIndex/currentStops.length)*100);
  document.getElementById('q-progress-fill').style.width = pct+'%';
  document.getElementById('q-count').textContent = (currentStopIndex+1)+'/'+currentStops.length;

  const livesStr = '‚ù§Ô∏è'.repeat(Math.max(0,state.lives))+'üñ§'.repeat(Math.max(0,5-state.lives));
  document.getElementById('q-lives-disp').textContent = livesStr;

  const body = document.getElementById('q-body');
  if(stop.type==='mc') body.innerHTML = renderMC(stop);
  else if(stop.type==='tf') body.innerHTML = renderTF(stop);
  else if(stop.type==='fill') body.innerHTML = renderFill(stop);

  if(stop.type==='mc'){
    document.querySelectorAll('.q-option').forEach((btn,i)=>{
      btn.addEventListener('click',()=>selectMC(i,stop));
    });
    document.getElementById('q-check-btn').addEventListener('click',()=>checkMC(stop));
  } else if(stop.type==='tf'){
    document.querySelectorAll('.q-tf-btn').forEach((btn,i)=>{
      btn.addEventListener('click',()=>checkTF(i===0,stop,btn));
    });
  } else if(stop.type==='fill'){
    const inp = document.getElementById('q-fill-input');
    inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&!answered) checkFill(stop); });
    document.getElementById('q-check-btn').addEventListener('click',()=>checkFill(stop));
  }
}

function renderMC(stop){
  const opts = stop.options||[];
  return `
    <div class="q-type-badge">√áoktan Se√ßmeli <small style="opacity:.6">(1-4 tu≈ülarƒ±)</small></div>
    <div class="q-question">${stop.question}</div>
    <div class="q-options">
      ${opts.map((o,i)=>`<button class="q-option" data-i="${i}"><span style="opacity:.5;font-size:12px">${i+1})</span> ${o}</button>`).join('')}
    </div>
    <button class="q-check-btn" id="q-check-btn" disabled>Kontrol Et</button>
    <div id="q-feedback"></div>
  `;
}

function renderTF(stop){
  return `
    <div class="q-type-badge">Doƒüru / Yanlƒ±≈ü <small style="opacity:.6">(T/F)</small></div>
    <div class="q-question">${stop.statement}</div>
    <div class="q-tf-options">
      <button class="q-tf-btn" data-val="true">‚úÖ<br><span style="font-size:13px;font-weight:700">Doƒüru</span></button>
      <button class="q-tf-btn" data-val="false">‚ùå<br><span style="font-size:13px;font-weight:700">Yanlƒ±≈ü</span></button>
    </div>
    <div id="q-feedback"></div>
  `;
}

function renderFill(stop){
  const tmpl = stop.template||'';
  const displayed = tmpl.replace('___','<span>___</span>');
  return `
    <div class="q-type-badge">Bo≈üluk Doldur</div>
    <div class="q-fill-wrap">
      <div class="q-fill-template">${displayed}</div>
      <input class="q-fill-input" id="q-fill-input" type="text" placeholder="Cevabƒ±nƒ± yaz..." autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <button class="q-check-btn" id="q-check-btn">Kontrol Et</button>
    <div id="q-feedback"></div>
  `;
}

// ============================================================
// ANSWER HANDLERS
// ============================================================
function selectMC(i, stop){
  if(answered) return;
  selectedAnswer = i;
  document.querySelectorAll('.q-option').forEach((btn,bi)=>{
    btn.classList.toggle('selected', bi===i);
  });
  document.getElementById('q-check-btn').disabled = false;
}

function checkMC(stop){
  if(answered || selectedAnswer===null) return;
  answered=true;
  const correct = selectedAnswer===stop.correct;
  document.querySelectorAll('.q-option').forEach((btn,bi)=>{
    btn.disabled=true;
    if(bi===stop.correct) btn.classList.add('correct');
    else if(bi===selectedAnswer && !correct) btn.classList.add('wrong');
  });
  document.getElementById('q-check-btn').disabled=true;
  handleResult(correct, stop.explanation);
}

function checkTF(userBool, stop, clickedBtn){
  if(answered) return;
  answered=true;
  const correct = userBool===stop.correct;
  document.querySelectorAll('.q-tf-btn').forEach(btn=>{
    btn.disabled=true;
    const v = btn.dataset.val==='true';
    if(v===stop.correct) btn.classList.add('correct');
    else if(btn===clickedBtn && !correct) btn.classList.add('wrong');
  });
  handleResult(correct, stop.explanation);
}

function checkFill(stop){
  if(answered) return;
  const inp = document.getElementById('q-fill-input');
  if(!inp||!inp.value.trim()) return;
  answered=true;
  const userVal = inp.value.trim().toLowerCase().replace(/[^a-z0-9ƒü√º≈üƒ±√∂√ß_\-]/g,'');
  const correctVal = (stop.answer||'').toLowerCase().replace(/[^a-z0-9ƒü√º≈üƒ±√∂√ß_\-]/g,'');
  const correct = userVal===correctVal;
  inp.disabled=true;
  inp.classList.add(correct?'correct':'wrong');
  document.getElementById('q-check-btn').disabled=true;
  handleResult(correct, stop.explanation);
}

function handleResult(correct, explanation){
  const prevXP = state.xp;
  if(correct){
    state.xp += 10;
    sessionXP += 10;
    state.dailyGoal.xp = (state.dailyGoal.xp||0) + 10;
    state.currentCombo = (state.currentCombo||0) + 1;
    const combo = state.currentCombo;
    let bonus = 0;
    if(combo >= 3){
      bonus = Math.min(combo, 12);
      state.xp += bonus;
      sessionXP += bonus;
      state.dailyGoal.xp += bonus;
    }
    playCorrect();
    mascotReact('happy');
    const flashMsg = combo>=3 ? `üî• ${combo}x Combo! +${10+bonus} XP` : '+10 XP';
    flashXP(flashMsg);
    if(combo >= 3) playComboSound();
    checkAchievements({combo});
  } else {
    sessionErrors++;
    state.lives = Math.max(0, state.lives-1);
    state.currentCombo = 0;
    playWrong();
    mascotReact('sad');
    // Shake
    const body = document.getElementById('q-body');
    if(body){ body.classList.remove('shaking'); void body.offsetWidth; body.classList.add('shaking'); }
    if(state.lives<=0){
      saveState();
      setTimeout(()=>{ showScreen('nolives'); },1500);
    }
  }
  saveState();
  checkAchievements({});
  showFeedback(correct, explanation, correct&&state.currentCombo>=3 ? state.currentCombo : 0);
}

function showFeedback(correct, explanation, combo=0){
  const fb = document.getElementById('q-feedback');
  const comboHtml = combo>=3 ? `<span class="combo-badge">üî• ${combo}x</span>` : '';
  fb.innerHTML=`
    <div class="q-feedback ${correct?'correct-fb':'wrong-fb'}">
      <div class="q-feedback-title ${correct?'c':'w'}">${correct?'üéâ Harika!':'üòÖ Yanlƒ±≈ü!'}${comboHtml}</div>
      <div class="q-feedback-exp">${explanation||''}</div>
    </div>
    <button class="q-continue-btn" onclick="nextStop()">Devam ‚Üí <small style="opacity:.6;font-size:12px">(Enter)</small></button>
  `;
}

function nextStop(){
  currentStopIndex++;
  if(currentStopIndex>=currentStops.length){
    finishTopic();
  } else {
    renderQuestion();
  }
}

function finishTopic(){
  const bonusXP = 25;
  state.xp += bonusXP;
  sessionXP += bonusXP;
  state.dailyGoal.xp = (state.dailyGoal.xp||0) + bonusXP;
  state.streak = (state.streak||0)+1;

  const perfect = sessionErrors===0;
  const noMistakes = state.lives===5 && sessionErrors===0;

  if(!state.completedTopics.includes(currentTopicId)){
    state.completedTopics.push(currentTopicId);
  }

  let unitComplete = false;
  const unit = CURRICULUM.units.find(u=>u.id===currentUnitId);
  if(unit){
    const allDone = unit.topics.every(t=>state.completedTopics.includes(t.id));
    if(allDone && !state.completedUnits.includes(currentUnitId)){
      state.completedUnits.push(currentUnitId);
      state.xp += 100;
      sessionXP += 100;
      unitComplete = true;
      launchConfetti();
    }
  }

  saveState();
  checkAchievements({perfect, noMistakes});

  const lvl = getLevelInfo(state.xp);
  document.getElementById('comp-title').textContent = unitComplete ? 'üéä √únite Tamamlandƒ±!' : 'üèÜ Konu Tamamlandƒ±!';
  document.getElementById('comp-xp').textContent = '+'+sessionXP+' XP';
  document.getElementById('comp-sub').textContent = `Seri: ${state.streak}üî• | Toplam: ${state.xp} XP`;
  document.getElementById('comp-level').textContent = `${lvl.emoji} ${lvl.label} Seviyesin`;
  playComplete();
  showScreen('completion');
}

function refillLives(){
  state.lives = 5;
  saveState();
  if(currentTopicId) startTopic(currentUnitId, currentTopicId);
  else showHome();
}

// ============================================================
// MASCOT
// ============================================================
function mascotReact(type){
  const el = document.getElementById('mascot-img');
  if(!el) return;
  el.style.transition='transform .2s,filter .2s';
  if(type==='happy'){
    el.style.transform='scale(1.4)';
    el.style.filter='brightness(1.5)';
  } else {
    el.style.transform='rotate(-15deg)';
    el.style.filter='grayscale(0.6)';
  }
  setTimeout(()=>{ el.style.transform=''; el.style.filter=''; }, 600);
}

// ============================================================
// CONFETTI
// ============================================================
function launchConfetti(){
  const colors=['#38bdf8','#22c55e','#fbbf24','#f43f5e','#a78bfa','#fb923c','#fff'];
  for(let i=0;i<35;i++){
    const el=document.createElement('div');
    el.className='confetti-piece';
    el.style.cssText=`left:${Math.random()*100}vw;background:${colors[Math.floor(Math.random()*colors.length)]};animation-duration:${1.4+Math.random()*1.2}s;animation-delay:${Math.random()*0.4}s;width:${5+Math.random()*9}px;height:${5+Math.random()*9}px;opacity:1`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 2800);
  }
}

// ============================================================
// XP FLASH
// ============================================================
function flashXP(text){
  const el = document.createElement('div');
  el.className='q-xp-flash';
  el.textContent=text;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 950);
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg, dur=2500){
  const el=document.createElement('div');
  el.className='toast';
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),dur);
}

// ============================================================
// TWITTER SHARE
// ============================================================
function shareTwitter(){
  const unit = CURRICULUM?.units?.find(u=>u.id===currentUnitId);
  const topic = unit?.topics?.find(t=>t.id===currentTopicId);
  const lvl = getLevelInfo(state.xp);
  const txt = `${lvl.emoji} TechDuo'da "${topic?.title||'bir konuyu'}" tamamladƒ±m! +${sessionXP} XP kazandƒ±m üéØ\n\nT√ºrk√ße teknoloji √∂ƒüreniyorum üáπüá∑ ‚Üí https://mahsumaktas.github.io/techduo/ #TechDuo`;
  window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');
}

// ============================================================
// PLACEMENT TEST
// ============================================================
let placementStops = [];
let placementIdx = 0;
let placementCorrect = 0;
let placementAnswered = false;

function startPlacementTest(){
  if(!CURRICULUM) return;
  placementStops = [];
  // Pick 1 random stop from each unit (skip first 2 ‚Äî too easy)
  CURRICULUM.units.slice(2).forEach(unit=>{
    if(unit.topics && unit.topics.length>0){
      const topic = unit.topics[Math.floor(Math.random()*unit.topics.length)];
      if(topic.stops && topic.stops.length>0){
        const stop = topic.stops[Math.floor(Math.random()*topic.stops.length)];
        placementStops.push({...stop, _unitId: unit.id});
      }
    }
  });
  // Limit to 8 questions
  placementStops = placementStops.slice(0,8);
  placementIdx = 0;
  placementCorrect = 0;
  placementAnswered = false;
  renderPlacementQuestion();
  showScreen('placement');
}

function renderPlacementQuestion(){
  const body = document.getElementById('placement-body');
  if(placementIdx >= placementStops.length){
    showPlacementResult();
    return;
  }
  const stop = placementStops[placementIdx];
  placementAnswered = false;
  const pct = Math.round((placementIdx/placementStops.length)*100);
  let qHtml = '';
  if(stop.type==='mc'){
    const opts = stop.options||[];
    qHtml = `<div class="q-options">${opts.map((o,i)=>`<button class="q-option" data-i="${i}" onclick="checkPlacementMC(${i},${stop.correct})">${String.fromCharCode(65+i)}) ${o}</button>`).join('')}</div>`;
  } else if(stop.type==='tf'){
    qHtml = `<div class="q-tf-options"><button class="q-tf-btn" onclick="checkPlacementTF(true,${stop.correct})">‚úÖ<br><span>Doƒüru</span></button><button class="q-tf-btn" onclick="checkPlacementTF(false,${stop.correct})">‚ùå<br><span>Yanlƒ±≈ü</span></button></div>`;
  } else {
    qHtml = `<div style="text-align:center;padding:20px 0"><button onclick="nextPlacement()" style="background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px 20px;color:var(--muted);cursor:pointer;font-size:14px">Bu soruyu ge√ß ‚Üí</button></div>`;
  }
  body.innerHTML = `
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px"><span>Soru ${placementIdx+1}/${placementStops.length}</span><span>${placementCorrect} doƒüru</span></div>
      <div style="height:6px;background:var(--border);border-radius:4px;overflow:hidden"><div style="height:100%;background:var(--purple);border-radius:4px;width:${pct}%;transition:width .4s"></div></div>
    </div>
    <div class="q-question" style="font-size:16px">${stop.question||stop.statement||''}</div>
    ${qHtml}
    <button onclick="nextPlacement()" style="background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;padding:8px 0;display:block">Ge√ß ‚Üí</button>
  `;
}

function checkPlacementMC(selected, correct){
  if(placementAnswered) return;
  placementAnswered = true;
  if(selected===correct) placementCorrect++;
  document.querySelectorAll('.q-option').forEach((btn,i)=>{
    btn.disabled=true;
    if(i===correct) btn.classList.add('correct');
    else if(i===selected) btn.classList.add('wrong');
  });
  setTimeout(nextPlacement, 900);
}

function checkPlacementTF(userBool, correctBool){
  if(placementAnswered) return;
  placementAnswered = true;
  const correct = userBool===(correctBool===true||correctBool==='true');
  if(correct) placementCorrect++;
  setTimeout(nextPlacement, 700);
}

function nextPlacement(){
  placementIdx++;
  renderPlacementQuestion();
}

function showPlacementResult(){
  const score = placementCorrect;
  const total = placementStops.length;
  let icon, title, sub, action;
  if(score<=2){
    icon='üå±'; title='Temel Seviye'; sub='Harika! Ba≈ülangƒ±√ßtan ilerleyelim. Her ≈üeyi √∂ƒüreneceksin!';
    action=`<button class="placement-result-btn" onclick="showHome()">üöÄ Ba≈ütan Ba≈üla</button>`;
  } else if(score<=5){
    icon='üìö'; title='Orta Seviye'; sub=`${score}/${total} doƒüru! 3. √ºniteden devam edebilirsin.`;
    action=`<button class="placement-result-btn" onclick="skipToUnit(2)">‚è© 3. √úniteden Ba≈üla</button>`;
  } else {
    icon='üí°'; title='ƒ∞leri Seviye'; sub=`Etkileyici! ${score}/${total} doƒüru. 5. √ºniteden devam et.`;
    action=`<button class="placement-result-btn" onclick="skipToUnit(4)">‚ö° 5. √úniteden Ba≈üla</button>`;
  }
  const body = document.getElementById('placement-body');
  body.innerHTML=`
    <div class="placement-result">
      <div class="placement-result-icon">${icon}</div>
      <div class="placement-result-title">${title}</div>
      <div class="placement-result-sub">${sub}</div>
      ${action}
      <button onclick="showHome()" style="background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;margin-top:14px;display:block;width:100%">‚Üê Ana Sayfaya D√∂n</button>
    </div>
  `;
}

function skipToUnit(targetUnitIdx){
  if(!CURRICULUM) return showHome();
  // Mark all topics before target unit as completed
  CURRICULUM.units.slice(0, targetUnitIdx).forEach(unit=>{
    unit.topics.forEach(t=>{ if(!state.completedTopics.includes(t.id)) state.completedTopics.push(t.id); });
    if(!state.completedUnits.includes(unit.id)) state.completedUnits.push(unit.id);
  });
  saveState();
  showToast('‚è© ƒ∞leri atlandƒ±!');
  setTimeout(()=>showHome(), 500);
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', e=>{
  const screen = document.querySelector('.screen.active');
  if(!screen || screen.id !== 'screen-question') return;
  const key = e.key.toLowerCase();
  const stop = currentStops[currentStopIndex];
  if(!stop) return;
  if(!answered){
    if(stop.type==='mc'){
      const map={'1':0,'2':1,'3':2,'4':3};
      if(map[key]!==undefined){ e.preventDefault(); selectMC(map[key],stop); }
      if(key==='enter'){ e.preventDefault(); const btn=document.getElementById('q-check-btn'); if(btn&&!btn.disabled) checkMC(stop); }
    } else if(stop.type==='tf'){
      if(key==='t'||key==='1'){ e.preventDefault(); document.querySelector('.q-tf-btn[data-val="true"]')?.click(); }
      if(key==='f'||key==='2'){ e.preventDefault(); document.querySelector('.q-tf-btn[data-val="false"]')?.click(); }
    } else if(stop.type==='fill'){
      if(key==='enter'){ e.preventDefault(); checkFill(stop); }
    }
  } else {
    if(key==='enter'||key===' '){ e.preventDefault(); document.querySelector('.q-continue-btn')?.click(); }
  }
});

// ============================================================
// INIT
// ============================================================
loadState();
updateHeader();

fetch('curriculum.json')
  .then(r=>r.json())
  .then(data=>{
    CURRICULUM=data;
    renderHome();
  })
  .catch(err=>{
    document.getElementById('unit-list').innerHTML='<p style="color:var(--red);padding:20px">curriculum.json y√ºklenemedi: '+err.message+'</p>';
  });
</script>
</body>
</html>
