<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‚ö° TechDuo</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#58CC02">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="TechDuo">
<style>
/* =============================================
   DUOLINGO COLOR PALETTE (WHITE THEME)
   ============================================= */
:root {
  --green:      #58CC02;
  --green-dark: #46A302;
  --green-bg:   #D7FFB8;
  --orange:     #FF9600;
  --orange-dark:#E07800;
  --red:        #FF4B4B;
  --red-dark:   #CC3333;
  --red-bg:     #FFDFE0;
  --blue:       #1CB0F6;
  --blue-dark:  #0099DD;
  --blue-bg:    #DDF4FF;
  --yellow:     #FFD900;
  --yellow-dark:#DDB900;
  --purple:     #CE82FF;
  --text:       #3C3C3C;
  --text-light: #777777;
  --light-bg:   #F7F7F7;
  --border:     #E5E5E5;
  --border-dark:#AFAFAF;
  --white:      #FFFFFF;
  --shadow:     rgba(0,0,0,0.08);
}

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  height: 100%;
  background: var(--light-bg);
  color: var(--text);
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  font-size: 16px;
  line-height: 1.5;
  overscroll-behavior: none;
}

#app {
  max-width: 480px;
  margin: 0 auto;
  min-height: 100vh;
  background: var(--white);
  position: relative;
  overflow-x: hidden;
  box-shadow: 0 0 40px var(--shadow);
}

/* =============================================
   SCREENS
   ============================================= */
.screen {
  display: none;
  min-height: 100vh;
  flex-direction: column;
}
.screen.active {
  display: flex;
}

/* =============================================
   SPLASH SCREEN
   ============================================= */
#screen-splash {
  align-items: center;
  justify-content: center;
  padding: 40px 24px;
  text-align: center;
  background: var(--white);
}

.splash-mascot {
  width: 180px;
  height: 180px;
  object-fit: cover;
  border-radius: 50%;
  margin-bottom: 28px;
  box-shadow: 0 8px 24px rgba(88,204,2,0.25);
  border: 4px solid var(--green);
}

.splash-mascot-fallback {
  width: 180px;
  height: 180px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--green), var(--orange));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 80px;
  margin: 0 auto 28px;
  box-shadow: 0 8px 24px rgba(88,204,2,0.25);
}

.splash-title {
  font-size: 36px;
  font-weight: 900;
  color: var(--text);
  margin-bottom: 10px;
  letter-spacing: -0.5px;
}

.splash-title span { color: var(--green); }

.splash-subtitle {
  font-size: 16px;
  color: var(--text-light);
  margin-bottom: 48px;
  font-weight: 500;
}

.splash-features {
  width: 100%;
  margin-bottom: 40px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.splash-feat {
  background: var(--light-bg);
  border-radius: 14px;
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  text-align: left;
}

.splash-feat-icon { font-size: 28px; flex-shrink: 0; }
.splash-feat-text { font-size: 14px; font-weight: 600; color: var(--text); }

/* =============================================
   HOME HEADER
   ============================================= */
.home-header {
  background: var(--white);
  border-bottom: 2px solid var(--border);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  gap: 8px;
}

.home-logo {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 900;
  color: var(--green);
  flex-shrink: 0;
}

.home-logo img {
  width: 30px;
  height: 30px;
  object-fit: cover;
  border-radius: 50%;
  transition: transform .2s, filter .2s;
}

.home-stats {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: nowrap;
}

.stat-pill {
  display: flex;
  align-items: center;
  gap: 3px;
  padding: 5px 9px;
  border-radius: 20px;
  border: 2px solid var(--border);
  background: var(--white);
  font-size: 13px;
  font-weight: 800;
  white-space: nowrap;
}

.stat-pill.xp-pill    { color: var(--orange); border-color: var(--orange); }
.stat-pill.str-pill   { color: #FF6B00; border-color: #FF6B00; }
.stat-pill.hp-pill    { color: var(--red); border-color: var(--red); }

.level-pill {
  display: flex;
  align-items: center;
  gap: 3px;
  padding: 5px 9px;
  border-radius: 20px;
  border: 2px solid var(--green);
  background: var(--green-bg);
  font-size: 12px;
  font-weight: 800;
  color: var(--green-dark);
  cursor: pointer;
  transition: filter .15s;
  white-space: nowrap;
}
.level-pill:hover { filter: brightness(0.95); }

.sound-btn {
  background: none;
  border: 2px solid var(--border);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: border-color .15s;
  flex-shrink: 0;
}
.sound-btn:hover { border-color: var(--green); }

/* =============================================
   DAILY GOAL BAR
   ============================================= */
.daily-goal-bar {
  background: var(--white);
  border: 2px solid var(--border);
  border-radius: 14px;
  padding: 12px 16px;
  margin: 12px 16px 0;
}

.daily-goal-header {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  font-weight: 800;
  margin-bottom: 8px;
  color: var(--text-light);
}

.daily-goal-track {
  height: 10px;
  background: var(--border);
  border-radius: 6px;
  overflow: hidden;
}

.daily-goal-fill {
  height: 100%;
  background: var(--green);
  border-radius: 6px;
  transition: width .5s ease;
}

.daily-goal-fill.complete { background: var(--green); }

/* =============================================
   HOME / UNIT MAP
   ============================================= */
#screen-home { flex-direction: column; }

.home-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.section-label {
  font-size: 12px;
  font-weight: 800;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-light);
  margin-bottom: 14px;
  padding-left: 4px;
}

/* Placement banner */
.placement-banner {
  background: linear-gradient(135deg, rgba(206,130,255,.12), rgba(28,176,246,.08));
  border: 2px solid rgba(206,130,255,.4);
  border-bottom: 4px solid rgba(206,130,255,.5);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: all .15s;
}
.placement-banner:hover { border-color: var(--purple); transform: translateY(-1px); }
.placement-banner-text { font-size: 14px; font-weight: 800; color: var(--purple); }
.placement-banner-sub  { font-size: 12px; color: var(--text-light); margin-top: 2px; }
.placement-banner-arrow { font-size: 22px; color: var(--purple); }

/* Unit cards */
.unit-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.unit-card {
  background: var(--white);
  border: 2px solid var(--border);
  border-bottom: 4px solid var(--border-dark);
  border-radius: 16px;
  padding: 16px;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  position: relative;
}

.unit-card:hover:not(.unit-locked) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow);
}
.unit-card:active:not(.unit-locked) { transform: translateY(1px); }
.unit-card.unit-active { border-color: var(--green); border-bottom-color: var(--green-dark); }
.unit-card.unit-done   { border-color: var(--green); border-bottom-color: var(--green-dark); background: #FAFFFE; }
.unit-card.unit-locked { opacity: .55; cursor: not-allowed; }

.unit-card-top {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 12px;
}

.unit-icon-wrap {
  width: 52px;
  height: 52px;
  border-radius: 14px;
  background: var(--light-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
}
.unit-card.unit-active .unit-icon-wrap,
.unit-card.unit-done .unit-icon-wrap { background: var(--green-bg); }
.unit-card.unit-locked .unit-icon-wrap { background: #F0F0F0; }

.unit-text { flex: 1; }
.unit-title { font-size: 16px; font-weight: 800; color: var(--text); margin-bottom: 3px; }
.unit-desc  { font-size: 12px; color: var(--text-light); line-height: 1.4; }
.unit-lock-icon { font-size: 24px; color: var(--border-dark); }

.unit-progress-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.unit-prog-bar {
  flex: 1;
  height: 8px;
  background: var(--border);
  border-radius: 6px;
  overflow: hidden;
}

.unit-prog-fill {
  height: 100%;
  background: var(--green);
  border-radius: 6px;
  transition: width 0.6s ease;
}

.unit-prog-pct {
  font-size: 12px;
  font-weight: 800;
  color: var(--text-light);
  min-width: 32px;
  text-align: right;
}

.unit-start-btn {
  margin-top: 12px;
  background: var(--green);
  border: none;
  border-bottom: 4px solid var(--green-dark);
  border-radius: 12px;
  width: 100%;
  padding: 12px;
  font-size: 15px;
  font-weight: 800;
  letter-spacing: .5px;
  text-transform: uppercase;
  color: white;
  cursor: pointer;
  transition: filter .15s;
}
.unit-start-btn:hover { filter: brightness(1.05); }
.unit-start-btn:active { transform: translateY(2px); border-bottom-width: 2px; }
.unit-start-btn.done-btn {
  background: var(--white);
  color: var(--green);
  border: 2px solid var(--green);
  border-bottom: 4px solid var(--green-dark);
}

/* =============================================
   TOPICS SCREEN
   ============================================= */
#screen-topics { flex-direction: column; }

.topics-header {
  background: var(--white);
  border-bottom: 2px solid var(--border);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.back-x-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid var(--border);
  background: var(--white);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: var(--text-light);
  flex-shrink: 0;
  transition: background .15s;
}
.back-x-btn:hover { background: var(--light-bg); }
.topics-header-title { font-size: 18px; font-weight: 800; color: var(--text); }

.topics-body { flex: 1; padding: 20px 16px; overflow-y: auto; }

.topic-list { display: flex; flex-direction: column; gap: 0; }

.topic-item { display: flex; align-items: stretch; gap: 0; position: relative; }

.topic-left {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 52px;
  flex-shrink: 0;
}

.topic-circle {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 3px solid var(--border);
  background: var(--white);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 800;
  color: var(--text-light);
  z-index: 1;
  flex-shrink: 0;
  transition: all .2s;
}
.topic-circle.done    { background: var(--green); border-color: var(--green); color: white; }
.topic-circle.current { background: var(--blue); border-color: var(--blue); color: white; box-shadow: 0 0 0 5px rgba(28,176,246,.2); }

.topic-line {
  flex: 1;
  width: 3px;
  background: var(--border);
  margin: 4px auto;
  min-height: 20px;
}
.topic-line.done { background: var(--green); }

.topic-right { flex: 1; padding: 0 0 20px 14px; padding-top: 4px; }

.topic-card {
  background: var(--white);
  border: 2px solid var(--border);
  border-bottom: 4px solid var(--border-dark);
  border-radius: 14px;
  padding: 14px 16px;
  cursor: pointer;
  transition: transform .12s, border-color .12s;
}
.topic-card:hover { border-color: var(--blue); transform: translateX(3px); }
.topic-card:active { transform: translateY(2px); border-bottom-width: 2px; }
.topic-card.done { border-color: var(--green); border-bottom-color: var(--green-dark); background: #FAFFFE; }
.topic-card-title { font-size: 15px; font-weight: 800; color: var(--text); margin-bottom: 4px; }
.topic-card-meta  { font-size: 12px; color: var(--text-light); }
.topic-card-done  { font-size: 12px; font-weight: 700; color: var(--green); margin-top: 4px; }

/* =============================================
   QUESTION SCREEN
   ============================================= */
#screen-question { flex-direction: column; background: var(--white); }

.q-top-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 16px 8px;
  background: var(--white);
}

.q-exit-btn {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  border: none;
  background: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: var(--border-dark);
  flex-shrink: 0;
  transition: color .15s;
}
.q-exit-btn:hover { color: var(--text); }

.q-progress-track {
  flex: 1;
  height: 14px;
  background: var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.q-progress-fill {
  height: 100%;
  background: var(--green);
  border-radius: 8px;
  transition: width .4s ease;
  min-width: 10px;
}

.q-hearts { font-size: 18px; letter-spacing: 2px; flex-shrink: 0; }

.q-body { flex: 1; padding: 24px 16px 120px; overflow-y: auto; }

.q-type-label {
  font-size: 12px;
  font-weight: 800;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-light);
  margin-bottom: 16px;
}

.q-question-text {
  font-size: 22px;
  font-weight: 800;
  color: var(--text);
  line-height: 1.4;
  margin-bottom: 28px;
}

/* MC Options ‚Äî Duolingo 3D style */
.q-options-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }

.q-opt-btn {
  width: 100%;
  background: var(--white);
  border: 2px solid var(--border);
  border-bottom: 4px solid #CECECE;
  border-radius: 14px;
  padding: 16px 18px;
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  text-align: left;
  cursor: pointer;
  transition: all .12s;
  display: flex;
  align-items: center;
  gap: 12px;
  outline: none;
}
.q-opt-btn:hover:not(:disabled) { border-color: var(--blue); border-bottom-color: var(--blue-dark); background: var(--blue-bg); transform: translateY(-1px); }
.q-opt-btn:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 2px; }
.q-opt-btn.selected { border-color: var(--blue); border-bottom-color: var(--blue-dark); background: var(--blue-bg); }
.q-opt-btn.correct  { border-color: var(--green)!important; border-bottom-color: var(--green-dark)!important; background: var(--green-bg)!important; color: var(--green)!important; }
.q-opt-btn.wrong    { border-color: var(--red)!important; border-bottom-color: var(--red-dark)!important; background: var(--red-bg)!important; color: var(--red)!important; }
.q-opt-btn:disabled { cursor: default; }

.q-opt-letter {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  background: var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 800;
  color: var(--text-light);
  flex-shrink: 0;
  transition: background .12s, color .12s;
}
.q-opt-btn.selected .q-opt-letter { background: var(--blue); color: white; }
.q-opt-btn.correct .q-opt-letter  { background: var(--green)!important; color: white!important; }
.q-opt-btn.wrong .q-opt-letter    { background: var(--red)!important; color: white!important; }

/* True/False ‚Äî Duolingo 3D */
.q-tf-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }

.q-tf-btn {
  background: var(--white);
  border: 2px solid var(--border);
  border-bottom: 4px solid #CECECE;
  border-radius: 14px;
  padding: 20px 12px;
  font-size: 15px;
  font-weight: 800;
  color: var(--text);
  cursor: pointer;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  transition: all .12s;
  outline: none;
}
.q-tf-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
.q-tf-btn:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 2px; }
.tf-icon { font-size: 32px; }
.q-tf-btn.selected { border-color: var(--blue); border-bottom-color: var(--blue-dark); background: var(--blue-bg); }
.q-tf-btn.correct  { border-color: var(--green)!important; border-bottom-color: var(--green-dark)!important; background: var(--green-bg)!important; color: var(--green)!important; }
.q-tf-btn.wrong    { border-color: var(--red)!important; border-bottom-color: var(--red-dark)!important; background: var(--red-bg)!important; color: var(--red)!important; }
.q-tf-btn:disabled { cursor: default; }

/* Fill in Blank */
.q-fill-template {
  font-size: 18px;
  line-height: 1.9;
  font-weight: 600;
  background: var(--light-bg);
  border-radius: 14px;
  padding: 18px 20px;
  margin-bottom: 20px;
  color: var(--text);
}
.q-fill-blank { display: inline-block; border-bottom: 3px solid var(--blue); color: var(--blue); font-weight: 800; min-width: 80px; padding: 0 4px; }

.q-fill-input {
  width: 100%;
  background: var(--white);
  border: 2px solid var(--border);
  border-bottom: 4px solid var(--border-dark);
  border-radius: 14px;
  padding: 16px 18px;
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  outline: none;
  transition: border-color .15s;
  margin-bottom: 20px;
}
.q-fill-input:focus          { border-color: var(--blue); border-bottom-color: var(--blue-dark); }
.q-fill-input.correct        { border-color: var(--green); border-bottom-color: var(--green-dark); background: var(--green-bg); color: var(--green); }
.q-fill-input.wrong          { border-color: var(--red); border-bottom-color: var(--red-dark); background: var(--red-bg); color: var(--red); }

/* Matching */
.q-match-area { margin-bottom: 20px; }
.q-match-hint { font-size: 13px; color: var(--text-light); margin-bottom: 14px; font-style: italic; }
.q-match-row  { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; margin-bottom: 10px; }
.q-match-left, .q-match-right {
  background: var(--white);
  border: 2px solid var(--border);
  border-bottom: 3px solid var(--border-dark);
  border-radius: 12px;
  padding: 12px 14px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  text-align: center;
  transition: all .12s;
  min-height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.q-match-left.selected, .q-match-right.selected { border-color: var(--blue); background: var(--blue-bg); color: var(--blue); }
.q-match-left.matched, .q-match-right.matched   { border-color: var(--green); background: var(--green-bg); color: var(--green); cursor: default; }
.q-match-arrow { font-size: 16px; color: var(--border-dark); }

/* Check button bar (bottom fixed) */
.q-check-bar {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  padding: 12px 16px 24px;
  background: var(--white);
  border-top: 2px solid var(--border);
  z-index: 200;
}

.q-check-btn {
  width: 100%;
  background: var(--border);
  border: none;
  border-bottom: 4px solid var(--border-dark);
  border-radius: 16px;
  padding: 16px;
  font-size: 16px;
  font-weight: 800;
  letter-spacing: .8px;
  text-transform: uppercase;
  color: var(--text-light);
  cursor: not-allowed;
  transition: all .15s;
  outline: none;
}
.q-check-btn.active { background: var(--green); border-bottom-color: var(--green-dark); color: white; cursor: pointer; }
.q-check-btn.active:hover { filter: brightness(1.05); }
.q-check-btn.active:active { transform: translateY(2px); border-bottom-width: 2px; }

/* =============================================
   FEEDBACK PANEL ‚Äî Duolingo signature slide-up
   ============================================= */
.feedback-panel {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%) translateY(100%);
  width: 100%;
  max-width: 480px;
  padding: 20px 20px 32px;
  border-radius: 20px 20px 0 0;
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  z-index: 300;
}
.feedback-panel.show    { transform: translateX(-50%) translateY(0); }
.feedback-panel.correct { background: var(--green-bg); border-top: 3px solid var(--green); }
.feedback-panel.wrong   { background: var(--red-bg); border-top: 3px solid var(--red); }

.feedback-title { font-size: 20px; font-weight: 900; margin-bottom: 6px; }
.feedback-panel.correct .feedback-title { color: var(--green); }
.feedback-panel.wrong .feedback-title   { color: var(--red); }

.feedback-combo { display: inline-block; background: linear-gradient(135deg, #FF9600, #FF4B4B); color: white; font-size: 13px; font-weight: 900; padding: 2px 10px; border-radius: 12px; margin-left: 8px; animation: comboPop .3s ease; }
@keyframes comboPop { 0%{transform:scale(.5)} 70%{transform:scale(1.2)} 100%{transform:scale(1)} }

.feedback-correct-answer { font-size: 14px; font-weight: 700; color: var(--red); margin-bottom: 8px; }
.feedback-explanation    { font-size: 14px; color: var(--text); line-height: 1.6; margin-bottom: 18px; }

.feedback-btn {
  width: 100%;
  border: none;
  border-radius: 16px;
  padding: 16px;
  font-size: 16px;
  font-weight: 800;
  letter-spacing: .8px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all .15s;
}
.feedback-panel.correct .feedback-btn { background: var(--green); border-bottom: 4px solid var(--green-dark); color: white; }
.feedback-panel.wrong .feedback-btn   { background: var(--red); border-bottom: 4px solid var(--red-dark); color: white; }
.feedback-btn:active { transform: translateY(2px); border-bottom-width: 2px; }

/* =============================================
   COMPLETION SCREEN
   ============================================= */
#screen-completion {
  align-items: center;
  justify-content: center;
  padding: 40px 24px;
  text-align: center;
  background: var(--white);
}

.comp-trophy { font-size: 80px; margin-bottom: 16px; animation: popIn .6s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes popIn { 0%{transform:scale(0) rotate(-15deg);opacity:0} 60%{transform:scale(1.2) rotate(5deg)} 100%{transform:scale(1) rotate(0deg);opacity:1} }

.comp-title { font-size: 30px; font-weight: 900; color: var(--text); margin-bottom: 8px; }
.comp-sub   { font-size: 15px; color: var(--text-light); margin-bottom: 32px; }

.comp-stats-row { display: flex; gap: 12px; margin-bottom: 32px; width: 100%; }
.comp-stat {
  flex: 1;
  background: var(--light-bg);
  border: 2px solid var(--border);
  border-bottom: 4px solid var(--border-dark);
  border-radius: 14px;
  padding: 16px 10px;
  text-align: center;
}
.comp-stat-val { font-size: 26px; font-weight: 900; margin-bottom: 4px; }
.comp-stat-val.xp-val     { color: var(--orange); }
.comp-stat-val.acc-val    { color: var(--blue); }
.comp-stat-val.streak-val { color: #FF6B00; }
.comp-stat-label { font-size: 11px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .5px; }

.comp-level-label { font-size: 14px; color: var(--text-light); margin-bottom: 20px; font-weight: 600; }

.comp-continue-btn {
  width: 100%;
  background: var(--green);
  border: none;
  border-bottom: 4px solid var(--green-dark);
  border-radius: 16px;
  padding: 18px;
  font-size: 17px;
  font-weight: 900;
  letter-spacing: .8px;
  text-transform: uppercase;
  color: white;
  cursor: pointer;
  transition: all .15s;
  margin-bottom: 12px;
}
.comp-continue-btn:hover   { filter: brightness(1.05); }
.comp-continue-btn:active  { transform: translateY(2px); border-bottom-width: 2px; }

.comp-share-btn {
  width: 100%;
  background: var(--white);
  border: 2px solid #1DA1F2;
  border-bottom: 4px solid #0d8bd9;
  border-radius: 16px;
  padding: 14px;
  font-size: 15px;
  font-weight: 800;
  color: #1DA1F2;
  cursor: pointer;
  transition: all .15s;
}
.comp-share-btn:hover  { background: #EAF6FF; }
.comp-share-btn:active { transform: translateY(2px); border-bottom-width: 2px; }

/* =============================================
   NO LIVES SCREEN
   ============================================= */
#screen-nolives {
  align-items: center;
  justify-content: center;
  padding: 40px 24px;
  text-align: center;
  background: var(--white);
}

.nolives-icon  { font-size: 80px; margin-bottom: 20px; animation: shakeAnim .5s ease; }
.nolives-title { font-size: 28px; font-weight: 900; color: var(--text); margin-bottom: 10px; }
.nolives-sub   { font-size: 15px; color: var(--text-light); margin-bottom: 36px; line-height: 1.6; }

.nolives-btn {
  width: 100%;
  border: none;
  border-radius: 16px;
  padding: 16px;
  font-size: 16px;
  font-weight: 800;
  letter-spacing: .5px;
  text-transform: uppercase;
  cursor: pointer;
  margin-bottom: 10px;
  transition: all .15s;
}
.nolives-btn.primary   { background: var(--green); border-bottom: 4px solid var(--green-dark); color: white; }
.nolives-btn.secondary { background: var(--white); border: 2px solid var(--border); border-bottom: 4px solid var(--border-dark); color: var(--text); }

/* =============================================
   PLACEMENT SCREEN
   ============================================= */
#screen-placement { flex-direction: column; }

.placement-header-bar {
  background: var(--white);
  border-bottom: 2px solid var(--border);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.placement-body-wrap { flex: 1; padding: 20px 16px; }
.placement-title { font-size: 22px; font-weight: 900; margin-bottom: 6px; }
.placement-sub   { font-size: 14px; color: var(--text-light); margin-bottom: 20px; line-height: 1.5; }

.placement-result      { text-align: center; padding: 30px 0; }
.placement-result-icon { font-size: 64px; margin-bottom: 14px; }
.placement-result-title{ font-size: 22px; font-weight: 900; margin-bottom: 8px; }
.placement-result-sub  { font-size: 14px; color: var(--text-light); margin-bottom: 24px; line-height: 1.5; }
.placement-result-btn  {
  background: var(--green);
  color: white;
  font-weight: 800;
  font-size: 16px;
  border: none;
  border-bottom: 4px solid var(--green-dark);
  border-radius: 14px;
  padding: 15px 30px;
  cursor: pointer;
  width: 100%;
}
.placement-skip-btn {
  background: none;
  border: none;
  color: var(--text-light);
  font-size: 13px;
  cursor: pointer;
  padding: 8px 0;
  display: block;
  margin-top: 12px;
  width: 100%;
}

/* =============================================
   STATS SCREEN
   ============================================= */
#screen-stats { flex-direction: column; }

.stats-header-bar {
  background: var(--white);
  border-bottom: 2px solid var(--border);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.stats-body-wrap { flex: 1; padding: 16px; overflow-y: auto; }

.stats-section-title {
  font-size: 14px;
  font-weight: 800;
  letter-spacing: .5px;
  text-transform: uppercase;
  color: var(--text-light);
  margin: 16px 0 10px;
}

.stat-card {
  background: var(--white);
  border: 2px solid var(--border);
  border-bottom: 4px solid var(--border-dark);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 10px;
}

.stat-card-label { font-size: 12px; color: var(--text-light); margin-bottom: 4px; text-transform: uppercase; letter-spacing: .5px; }
.stat-card-val   { font-size: 30px; font-weight: 900; }
.stat-card-val.yellow { color: var(--orange); }
.stat-card-val.green  { color: var(--green); }
.stat-card-val.blue   { color: var(--blue); }
.stat-card-val.red    { color: var(--red); }

.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }

.level-stat-card {
  background: var(--green-bg);
  border: 2px solid var(--green);
  border-bottom: 4px solid var(--green-dark);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  margin-bottom: 10px;
}
.level-emoji  { font-size: 42px; margin-bottom: 8px; }
.level-name   { font-size: 22px; font-weight: 900; color: var(--green-dark); margin-bottom: 4px; }
.level-next   { font-size: 13px; color: var(--text-light); }

.achievements-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ach-card {
  background: var(--light-bg);
  border: 2px solid var(--border);
  border-radius: 14px;
  padding: 14px;
  text-align: center;
  transition: all .2s;
}
.ach-card.unlocked { border-color: var(--yellow); background: #FFFDE7; }
.ach-card-icon  { font-size: 26px; margin-bottom: 6px; opacity: .3; }
.ach-card.unlocked .ach-card-icon { opacity: 1; }
.ach-card-label { font-size: 11px; color: var(--text-light); font-weight: 700; }
.ach-card.unlocked .ach-card-label { color: var(--text); }

/* =============================================
   ACHIEVEMENTS TOAST
   ============================================= */
.achievement-toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--white);
  border: 2px solid var(--yellow);
  border-bottom: 4px solid var(--yellow-dark);
  border-radius: 16px;
  padding: 14px 20px;
  font-size: 14px;
  font-weight: 700;
  z-index: 9999;
  animation: achIn .4s ease;
  text-align: center;
  min-width: 220px;
  box-shadow: 0 8px 30px rgba(0,0,0,.12);
  color: var(--text);
}
@keyframes achIn { 0%{opacity:0;transform:translateX(-50%) scale(.7)} 70%{transform:translateX(-50%) scale(1.05)} 100%{opacity:1;transform:translateX(-50%) scale(1)} }
.ach-toast-label { color: var(--orange); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; font-weight: 800; }

/* Level Up Overlay */
.levelup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
  animation: fadeInBg .3s ease;
}
@keyframes fadeInBg { from{opacity:0} to{opacity:1} }
.levelup-card {
  background: var(--white);
  border: 3px solid var(--yellow);
  border-bottom: 6px solid var(--yellow-dark);
  border-radius: 24px;
  padding: 36px 28px;
  text-align: center;
  max-width: 320px;
  width: 90%;
  animation: popIn .4s cubic-bezier(.36,.07,.19,.97);
}
.levelup-emoji { font-size: 56px; margin-bottom: 12px; }
.levelup-title { font-size: 26px; font-weight: 900; color: var(--orange); margin-bottom: 8px; }
.levelup-sub   { font-size: 15px; color: var(--text-light); margin-bottom: 20px; }
.levelup-btn {
  background: var(--yellow);
  color: #5a3e00;
  font-weight: 800;
  border: none;
  border-bottom: 4px solid var(--yellow-dark);
  border-radius: 12px;
  padding: 14px 32px;
  font-size: 16px;
  cursor: pointer;
  width: 100%;
}

/* XP Flash */
.xp-flash {
  position: fixed;
  top: 80px;
  right: 20px;
  background: var(--yellow);
  color: #5a3e00;
  font-size: 15px;
  font-weight: 900;
  border-radius: 20px;
  padding: 8px 16px;
  pointer-events: none;
  z-index: 999;
  animation: floatUp .9s forwards;
}
@keyframes floatUp { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-40px)} }

/* Toast */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: var(--white);
  border-radius: 20px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 700;
  z-index: 9990;
  animation: floatUp 2.5s forwards;
  white-space: nowrap;
  max-width: 90vw;
}

/* Confetti */
.confetti-piece {
  position: fixed;
  width: 10px;
  height: 10px;
  border-radius: 2px;
  pointer-events: none;
  z-index: 9999;
  animation: confettiFall linear forwards;
}
@keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }

/* Animations */
@keyframes shakeAnim { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
.shaking { animation: shakeAnim .4s ease; }

/* Primary Button */
.btn-primary {
  width: 100%;
  background: var(--green);
  border: none;
  border-bottom: 4px solid var(--green-dark);
  border-radius: 16px;
  padding: 18px;
  font-size: 16px;
  font-weight: 900;
  letter-spacing: .8px;
  text-transform: uppercase;
  color: white;
  cursor: pointer;
  transition: all .15s;
  outline: none;
  display: block;
}
.btn-primary:hover  { filter: brightness(1.05); }
.btn-primary:active { transform: translateY(2px); border-bottom-width: 2px; }
</style>
</head>
<body>
<div id="app">

  <!-- ========== SPLASH SCREEN ========== -->
  <div class="screen" id="screen-splash">
    <img class="splash-mascot" src="assets/mascot.jpg" alt="TechDuo Maskotu"
         onerror="this.style.display='none'; document.getElementById('mascot-fallback').style.display='flex';">
    <div class="splash-mascot-fallback" id="mascot-fallback" style="display:none">‚ö°</div>

    <div class="splash-title">‚ö° <span>TechDuo</span></div>
    <div class="splash-subtitle">T√ºrk√ße teknoloji √∂ƒürenme oyunu</div>

    <div class="splash-features">
      <div class="splash-feat">
        <div class="splash-feat-icon">üéØ</div>
        <div class="splash-feat-text">Kƒ±sa dersler, hƒ±zlƒ± ilerleme</div>
      </div>
      <div class="splash-feat">
        <div class="splash-feat-icon">‚ù§Ô∏è</div>
        <div class="splash-feat-text">Can sistemi ile heyecanlƒ± √∂ƒürenme</div>
      </div>
      <div class="splash-feat">
        <div class="splash-feat-icon">‚≠ê</div>
        <div class="splash-feat-text">XP kazan, seviye atla, ba≈üarƒ± topla</div>
      </div>
    </div>

    <button class="btn-primary" onclick="showHome()">BA≈ûLA ‚Üí</button>
  </div>

  <!-- ========== HOME SCREEN ========== -->
  <div class="screen" id="screen-home">
    <header class="home-header">
      <div class="home-logo">
        <img src="assets/mascot.jpg" id="mascot-img" alt="TechDuo" onerror="this.style.display='none'">
        ‚ö° TechDuo
      </div>
      <div class="home-stats">
        <div class="level-pill" id="level-pill" onclick="showStats()" title="ƒ∞statistikler">üå±</div>
        <div class="stat-pill xp-pill">‚≠ê <span id="xp-disp">0</span></div>
        <div class="stat-pill str-pill">üî• <span id="streak-disp">0</span></div>
        <div class="stat-pill hp-pill">‚ù§Ô∏è <span id="lives-disp">5</span></div>
        <button class="sound-btn" id="sound-btn" onclick="toggleSound()" title="Ses">üîä</button>
      </div>
    </header>
    <div id="daily-goal-container"></div>
    <div class="home-body">
      <div class="placement-banner" id="placement-banner" onclick="startPlacementTest()">
        <div>
          <div class="placement-banner-text">üéØ Seviyeni Test Et</div>
          <div class="placement-banner-sub">Bilgini √∂l√ß, doƒüru yerden ba≈üla</div>
        </div>
        <div class="placement-banner-arrow">‚Üí</div>
      </div>
      <div class="section-label">Kurs Haritasƒ±</div>
      <div class="unit-cards" id="unit-list"></div>
    </div>
  </div>

  <!-- ========== TOPICS SCREEN ========== -->
  <div class="screen" id="screen-topics">
    <div class="topics-header">
      <button class="back-x-btn" onclick="showHome()">‚úï</button>
      <div class="topics-header-title" id="topics-unit-title">√únite</div>
    </div>
    <div class="topics-body">
      <div class="topic-list" id="topic-list"></div>
    </div>
  </div>

  <!-- ========== QUESTION SCREEN ========== -->
  <div class="screen" id="screen-question">
    <div class="q-top-bar">
      <button class="q-exit-btn" onclick="exitQuestion()">‚úï</button>
      <div class="q-progress-track">
        <div class="q-progress-fill" id="q-prog-fill" style="width:0%"></div>
      </div>
      <div class="q-hearts" id="q-hearts-disp">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    <div class="q-body" id="q-body"></div>
    <div class="q-check-bar">
      <button class="q-check-btn" id="q-check-btn" disabled onclick="checkAnswer()">Kontrol Et</button>
    </div>
    <div class="feedback-panel" id="feedback-panel">
      <div class="feedback-title" id="fb-title"></div>
      <div class="feedback-correct-answer" id="fb-correct-ans" style="display:none"></div>
      <div class="feedback-explanation" id="fb-explanation"></div>
      <button class="feedback-btn" id="fb-btn" onclick="nextStop()">DEVAM ‚Üí <small style="opacity:.5;font-size:12px">(Enter)</small></button>
    </div>
  </div>

  <!-- ========== PLACEMENT SCREEN ========== -->
  <div class="screen" id="screen-placement">
    <div class="placement-header-bar">
      <button class="back-x-btn" onclick="showHome()">‚úï</button>
      <div class="topics-header-title">üéØ Seviye Testi</div>
    </div>
    <div class="placement-body-wrap">
      <div class="placement-sub">10 hƒ±zlƒ± soru ile seviyeni belirle. Cevaplamak zorunda deƒüilsin ‚Äî ge√ß de diyebilirsin!</div>
      <div id="placement-body"></div>
    </div>
  </div>

  <!-- ========== STATS SCREEN ========== -->
  <div class="screen" id="screen-stats">
    <div class="stats-header-bar">
      <button class="back-x-btn" onclick="showHome()">‚úï</button>
      <div class="topics-header-title">üìä ƒ∞statistikler</div>
    </div>
    <div class="stats-body-wrap" id="stats-body"></div>
  </div>

  <!-- ========== COMPLETION SCREEN ========== -->
  <div class="screen" id="screen-completion">
    <div class="comp-trophy">üèÜ</div>
    <div class="comp-title" id="comp-title">Konu Tamamlandƒ±!</div>
    <div class="comp-sub" id="comp-sub">Harika i≈ü √ßƒ±kardƒ±n!</div>
    <div class="comp-stats-row">
      <div class="comp-stat">
        <div class="comp-stat-val xp-val" id="comp-xp">+0</div>
        <div class="comp-stat-label">XP Kazandƒ±n</div>
      </div>
      <div class="comp-stat">
        <div class="comp-stat-val acc-val" id="comp-acc">0%</div>
        <div class="comp-stat-label">Doƒüruluk</div>
      </div>
      <div class="comp-stat">
        <div class="comp-stat-val streak-val" id="comp-streak">0</div>
        <div class="comp-stat-label">Seri üî•</div>
      </div>
    </div>
    <div class="comp-level-label" id="comp-level-label"></div>
    <button class="comp-continue-btn" onclick="afterCompletion()">DEVAM ET ‚Üí</button>
    <button class="comp-share-btn" onclick="shareTwitter()">üê¶ X'te Payla≈ü</button>
  </div>

  <!-- ========== NO LIVES SCREEN ========== -->
  <div class="screen" id="screen-nolives">
    <div class="nolives-icon">üíî</div>
    <div class="nolives-title">Canlar T√ºkendi!</div>
    <div class="nolives-sub">
      Biraz dinlen, sonra tekrar dene.<br>
      Ya da pratik modda devam et ‚Äî cansƒ±z oyna!
    </div>
    <button class="nolives-btn primary" onclick="refillLives()">üíñ Canlarƒ± Yenile</button>
    <button class="nolives-btn secondary" onclick="showHome()">üè† Ana Sayfaya D√∂n</button>
  </div>

</div><!-- #app -->

<script>
/* ============================================================
   SOUND SYSTEM ‚Äî Web Audio API
   ============================================================ */
let audioCtx = null;
function getAudio() {
  if (!audioCtx) {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  }
  return audioCtx;
}
function playTone(freq, dur, type='sine', vol=0.22) {
  try {
    const ctx = getAudio(); if (!ctx) return;
    if (ctx.state === 'suspended') ctx.resume();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = freq; o.type = type;
    g.gain.setValueAtTime(vol, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    o.start(); o.stop(ctx.currentTime + dur);
  } catch(e) {}
}
function playCorrect() {
  if (!state.soundEnabled) return;
  playTone(880, 0.12); setTimeout(() => playTone(1100, 0.1), 130);
}
function playWrong() {
  if (!state.soundEnabled) return;
  playTone(200, 0.35, 'sawtooth', 0.18);
}
function playComboSound() {
  if (!state.soundEnabled) return;
  [400, 600, 900].forEach((f, i) => setTimeout(() => playTone(f, 0.1), i * 70));
}
function playComplete() {
  if (!state.soundEnabled) return;
  [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playTone(f, 0.18), i * 110));
}
function toggleSound() {
  state.soundEnabled = !state.soundEnabled;
  document.getElementById('sound-btn').textContent = state.soundEnabled ? 'üîä' : 'üîá';
  saveState();
}

/* ============================================================
   LEVEL SYSTEM
   ============================================================ */
const LEVELS = [
  { min: 0,    label: '√áaylak',   emoji: 'üå±', next: 100 },
  { min: 100,  label: '√ñƒürenci',  emoji: 'üìö', next: 300 },
  { min: 300,  label: 'Uzman',    emoji: 'üí°', next: 700 },
  { min: 700,  label: 'M√ºhendis', emoji: '‚öôÔ∏è', next: 1500 },
  { min: 1500, label: 'Usta',     emoji: 'üèÜ', next: 3000 },
  { min: 3000, label: 'Efsane',   emoji: 'üåü', next: Infinity },
];
function getLevelInfo(xp) {
  return [...LEVELS].reverse().find(l => xp >= l.min) || LEVELS[0];
}

/* ============================================================
   ACHIEVEMENTS
   ============================================================ */
const ACHIEVEMENTS = [
  { id: 'first_correct', icon: 'üéØ', label: 'ƒ∞lk Adƒ±m',     desc: 'ƒ∞lk doƒüru cevap' },
  { id: 'streak_3',      icon: 'üî•', label: 'Ate≈üli',       desc: '3 ardƒ±≈üƒ±k doƒüru' },
  { id: 'xp_100',        icon: 'üíØ', label: 'Y√ºzl√ºk',       desc: '100 XP kazan' },
  { id: 'xp_500',        icon: 'üí™', label: 'G√º√ßleniyorum', desc: '500 XP kazan' },
  { id: 'first_unit',    icon: 'üéä', label: '√únite Ustasƒ±', desc: 'ƒ∞lk √ºniteyi bitir' },
  { id: 'perfect_topic', icon: '‚ú®', label: 'M√ºkemmel',     desc: 'Sƒ±fƒ±r hatayla konu bitir' },
  { id: 'no_mistakes',   icon: 'üõ°Ô∏è', label: 'Demir Kalkan', desc: 'Can kaybetmeden konu bitir' },
  { id: 'all_units',     icon: 'üåü', label: 'Tam Tur',      desc: 'T√ºm √ºniteleri tamamla' },
];

function checkAchievements(extra = {}) {
  ACHIEVEMENTS.forEach(a => {
    if (state.achievements.includes(a.id)) return;
    let unlock = false;
    if (a.id === 'first_correct' && state.xp >= 10) unlock = true;
    if (a.id === 'streak_3' && (extra.combo || 0) >= 3) unlock = true;
    if (a.id === 'xp_100' && state.xp >= 100) unlock = true;
    if (a.id === 'xp_500' && state.xp >= 500) unlock = true;
    if (a.id === 'first_unit' && state.completedUnits.length >= 1) unlock = true;
    if (a.id === 'perfect_topic' && extra.perfect) unlock = true;
    if (a.id === 'no_mistakes' && extra.noMistakes) unlock = true;
    if (a.id === 'all_units' && CURRICULUM && state.completedUnits.length >= CURRICULUM.units.length) unlock = true;
    if (unlock) {
      state.achievements.push(a.id);
      showAchievementToast(a);
      saveState();
    }
  });
}

function showAchievementToast(a) {
  const el = document.createElement('div');
  el.className = 'achievement-toast';
  el.innerHTML = `<div class="ach-toast-label">üèÜ Ba≈üarƒ± A√ßƒ±ldƒ±!</div><div style="font-size:24px;margin:4px 0">${a.icon}</div><div style="font-weight:800">${a.label}</div><div style="font-size:12px;color:var(--text-light);margin-top:2px">${a.desc}</div>`;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity .4s'; setTimeout(() => el.remove(), 400); }, 3000);
}

/* ============================================================
   STATE
   ============================================================ */
const DEFAULT_STATE = {
  xp: 0, streak: 0, lives: 5,
  completedTopics: [], completedUnits: [],
  soundEnabled: true, currentCombo: 0,
  achievements: [], dailyGoal: { date: '', xp: 0 },
  lastPracticeDate: '', lastLevel: '√áaylak'
};
let state = {};

function loadState() {
  try { state = JSON.parse(localStorage.getItem('techduo_v3') || '{}'); } catch(e) {}
  state = Object.assign({}, DEFAULT_STATE, state);
  // Ensure nested objects
  if (!state.dailyGoal || typeof state.dailyGoal !== 'object') state.dailyGoal = { date: '', xp: 0 };
  if (!Array.isArray(state.achievements)) state.achievements = [];
  if (!Array.isArray(state.completedTopics)) state.completedTopics = [];
  if (!Array.isArray(state.completedUnits)) state.completedUnits = [];
  // Reset daily goal if new day
  const today = new Date().toISOString().split('T')[0];
  if (state.dailyGoal.date !== today) {
    state.dailyGoal = { date: today, xp: 0 };
  }
}

function saveState() {
  localStorage.setItem('techduo_v3', JSON.stringify(state));
  updateHUD();
}

function updateHUD() {
  const xpEl = document.getElementById('xp-disp');
  if (xpEl) xpEl.textContent = state.xp;
  const strEl = document.getElementById('streak-disp');
  if (strEl) strEl.textContent = state.streak;
  const hpEl = document.getElementById('lives-disp');
  if (hpEl) hpEl.textContent = state.lives;

  // Level badge
  const lvl = getLevelInfo(state.xp);
  const pill = document.getElementById('level-pill');
  if (pill) pill.textContent = lvl.emoji + ' ' + lvl.label;

  // Sound btn
  const sBtn = document.getElementById('sound-btn');
  if (sBtn) sBtn.textContent = state.soundEnabled ? 'üîä' : 'üîá';

  // Level up check
  if (state.lastLevel && state.lastLevel !== lvl.label && state.xp > 0) {
    showLevelUp(lvl);
  }
  state.lastLevel = lvl.label;
}

function showLevelUp(lvl) {
  const overlay = document.createElement('div');
  overlay.className = 'levelup-overlay';
  overlay.innerHTML = `
    <div class="levelup-card">
      <div class="levelup-emoji">${lvl.emoji}</div>
      <div class="levelup-title">Seviye Atladƒ±n!</div>
      <div class="levelup-sub">Artƒ±k <strong>${lvl.label}</strong> seviyesindesin üéâ</div>
      <button class="levelup-btn" onclick="this.closest('.levelup-overlay').remove()">Harika! ‚Üí</button>
    </div>`;
  document.body.appendChild(overlay);
  playComplete();
}

/* ============================================================
   DAILY GOAL
   ============================================================ */
function renderDailyGoal() {
  const container = document.getElementById('daily-goal-container');
  if (!container) return;
  const goal = state.dailyGoal;
  const pct = Math.min(100, Math.round((goal.xp / 50) * 100));
  const done = pct >= 100;
  container.innerHTML = `
    <div class="daily-goal-bar">
      <div class="daily-goal-header">
        <span>üìÖ G√ºnl√ºk Hedef (50 XP)</span>
        <span style="color:${done ? 'var(--green)' : 'var(--text-light)'}">${done ? '‚úÖ Tamamlandƒ±!' : goal.xp + '/50 XP'}</span>
      </div>
      <div class="daily-goal-track">
        <div class="daily-goal-fill${done ? ' complete' : ''}" style="width:${pct}%"></div>
      </div>
    </div>`;
}

/* ============================================================
   CURRICULUM & NAVIGATION
   ============================================================ */
let CURRICULUM = null;
let currentUnitId = null;
let currentTopicId = null;
let currentStops = [];
let currentStopIdx = 0;
let sessionXP = 0;
let sessionCorrect = 0;
let sessionTotal = 0;
let sessionErrors = 0;
let selectedAnswer = null;
let answered = false;
let selectedMatchLeft = null;
let matchedPairs = 0;
let totalPairs = 0;

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-' + id);
  if (el) el.classList.add('active');
  window.scrollTo(0, 0);
}

function showHome() {
  hideFeedback();
  renderHome();
  showScreen('home');
}

function showTopics(unitId) {
  hideFeedback();
  currentUnitId = unitId;
  renderTopics(unitId);
  showScreen('topics');
}

function showStats() {
  renderStats();
  showScreen('stats');
}

function startTopic(unitId, topicId) {
  if (state.lives <= 0) { showScreen('nolives'); return; }
  currentUnitId = unitId;
  currentTopicId = topicId;
  const unit = CURRICULUM.units.find(u => u.id === unitId);
  const topic = unit.topics.find(t => t.id === topicId);
  currentStops = [...(topic.stops || [])];
  currentStopIdx = 0;
  sessionXP = 0;
  sessionCorrect = 0;
  sessionTotal = 0;
  sessionErrors = 0;
  selectedAnswer = null;
  answered = false;
  selectedMatchLeft = null;
  matchedPairs = 0;
  state.currentCombo = 0;
  renderQuestionScreen();
  showScreen('question');
}

function exitQuestion() {
  hideFeedback();
  if (currentUnitId) showTopics(currentUnitId);
  else showHome();
}

function afterCompletion() {
  const unit = CURRICULUM.units.find(u => u.id === currentUnitId);
  if (!unit) { showHome(); return; }
  const idx = unit.topics.findIndex(t => t.id === currentTopicId);
  if (idx >= 0 && idx < unit.topics.length - 1) showTopics(currentUnitId);
  else showHome();
}

/* ============================================================
   RENDER HOME
   ============================================================ */
function renderHome() {
  if (!CURRICULUM) return;
  updateHUD();
  renderDailyGoal();

  // Hide placement banner if already started
  const pb = document.getElementById('placement-banner');
  if (pb) pb.style.display = state.completedUnits.length > 0 ? 'none' : 'flex';

  const list = document.getElementById('unit-list');
  list.innerHTML = '';

  CURRICULUM.units.forEach((unit, ui) => {
    const topics = unit.topics || [];
    const doneCnt = topics.filter(t => state.completedTopics.includes(t.id)).length;
    const pct = topics.length > 0 ? Math.round((doneCnt / topics.length) * 100) : 0;
    const isDone = state.completedUnits.includes(unit.id);
    const prevDone = ui === 0 || state.completedUnits.includes(CURRICULUM.units[ui - 1].id);
    const isLocked = ui > 0 && !prevDone;
    const stateClass = isDone ? 'unit-done' : isLocked ? 'unit-locked' : 'unit-active';

    const card = document.createElement('div');
    card.className = 'unit-card ' + stateClass;
    card.innerHTML = `
      <div class="unit-card-top">
        <div class="unit-icon-wrap">${unit.emoji || 'üìö'}</div>
        <div class="unit-text">
          <div class="unit-title">${unit.title}</div>
          <div class="unit-desc">${unit.description || ''}</div>
        </div>
        ${isLocked ? '<div class="unit-lock-icon">üîí</div>' : ''}
      </div>
      <div class="unit-progress-row">
        <div class="unit-prog-bar">
          <div class="unit-prog-fill" style="width:${pct}%"></div>
        </div>
        <div class="unit-prog-pct">${pct}%</div>
      </div>
      ${!isLocked ? `<button class="unit-start-btn ${isDone ? 'done-btn' : ''}"
        onclick="event.stopPropagation(); showTopics('${unit.id}')">
        ${isDone ? 'üîÅ Tekrar Et' : '‚ñ∂ BA≈ûLA'}
      </button>` : ''}
    `;
    if (!isLocked) {
      card.style.cursor = 'pointer';
      card.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') return;
        showTopics(unit.id);
      });
    }
    list.appendChild(card);
  });
}

/* ============================================================
   RENDER TOPICS
   ============================================================ */
function renderTopics(unitId) {
  const unit = CURRICULUM.units.find(u => u.id === unitId);
  if (!unit) return;
  document.getElementById('topics-unit-title').textContent = unit.emoji + ' ' + unit.title;
  const list = document.getElementById('topic-list');
  list.innerHTML = '';
  const topics = unit.topics || [];

  topics.forEach((topic, ti) => {
    const isDone = state.completedTopics.includes(topic.id);
    const prevDone = ti === 0 || state.completedTopics.includes(topics[ti - 1].id);
    const isCurrent = !isDone && prevDone;
    const isLast = ti === topics.length - 1;
    const stopCount = (topic.stops || []).length;

    const item = document.createElement('div');
    item.className = 'topic-item';
    item.innerHTML = `
      <div class="topic-left">
        <div class="topic-circle ${isDone ? 'done' : isCurrent ? 'current' : ''}">
          ${isDone ? '‚úì' : isCurrent ? '‚ñ∂' : ti + 1}
        </div>
        ${!isLast ? `<div class="topic-line ${isDone ? 'done' : ''}"></div>` : ''}
      </div>
      <div class="topic-right">
        <div class="topic-card ${isDone ? 'done' : !isCurrent ? 'locked' : ''}"
          ${isCurrent || isDone ? `onclick="startTopic('${unitId}','${topic.id}')"` : ''}
          style="${!isCurrent && !isDone ? 'opacity:.5;cursor:not-allowed' : ''}">
          <div class="topic-card-title">${topic.title}</div>
          <div class="topic-card-meta">${stopCount} soru</div>
          ${isDone ? '<div class="topic-card-done">‚úÖ Tamamlandƒ±</div>' : ''}
        </div>
      </div>`;
    list.appendChild(item);
  });
}

/* ============================================================
   STATS SCREEN
   ============================================================ */
function renderStats() {
  const lvl = getLevelInfo(state.xp);
  const totalTopics = CURRICULUM ? CURRICULUM.units.reduce((s, u) => s + (u.topics?.length || 0), 0) : 0;
  const totalUnits  = CURRICULUM ? CURRICULUM.units.length : 0;
  const nextXP = lvl.next === Infinity ? '‚àû' : lvl.next;
  const body = document.getElementById('stats-body');
  body.innerHTML = `
    <div class="level-stat-card">
      <div class="level-emoji">${lvl.emoji}</div>
      <div class="level-name">${lvl.label}</div>
      <div class="level-next">Sonraki seviye: ${nextXP} XP</div>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-card-label">Toplam XP</div><div class="stat-card-val yellow">${state.xp}</div></div>
      <div class="stat-card"><div class="stat-card-label">Seri</div><div class="stat-card-val" style="color:#FF6B00">üî• ${state.streak}</div></div>
      <div class="stat-card"><div class="stat-card-label">Tamamlanan Konu</div><div class="stat-card-val green">${state.completedTopics.length}/${totalTopics}</div></div>
      <div class="stat-card"><div class="stat-card-label">Tamamlanan √únite</div><div class="stat-card-val blue">${state.completedUnits.length}/${totalUnits}</div></div>
    </div>
    <div class="stats-section-title">Ba≈üarƒ±lar (${state.achievements.length}/${ACHIEVEMENTS.length})</div>
    <div class="achievements-grid">
      ${ACHIEVEMENTS.map(a => {
        const unlocked = state.achievements.includes(a.id);
        return `<div class="ach-card${unlocked ? ' unlocked' : ''}">
          <div class="ach-card-icon">${a.icon}</div>
          <div class="ach-card-label">${a.label}</div>
        </div>`;
      }).join('')}
    </div>
  `;
}

/* ============================================================
   QUESTION SCREEN
   ============================================================ */
function renderQuestionScreen() {
  const stop = currentStops[currentStopIdx];
  if (!stop) return;

  selectedAnswer = null;
  answered = false;
  selectedMatchLeft = null;
  matchedPairs = 0;

  const pct = Math.round((currentStopIdx / currentStops.length) * 100);
  document.getElementById('q-prog-fill').style.width = pct + '%';

  const hp = Math.max(0, state.lives);
  document.getElementById('q-hearts-disp').textContent =
    '‚ù§Ô∏è'.repeat(hp) + 'üñ§'.repeat(Math.max(0, 5 - hp));

  const checkBtn = document.getElementById('q-check-btn');
  checkBtn.disabled = true;
  checkBtn.className = 'q-check-btn';
  checkBtn.textContent = 'Kontrol Et';

  hideFeedback();

  const body = document.getElementById('q-body');
  if (stop.type === 'mc')          body.innerHTML = renderMC(stop);
  else if (stop.type === 'tf')     body.innerHTML = renderTF(stop);
  else if (stop.type === 'fill')   body.innerHTML = renderFill(stop);
  else if (stop.type === 'eslestime') body.innerHTML = renderMatch(stop);
  else body.innerHTML = `<p style="color:var(--text-light)">Bilinmeyen soru tipi: ${stop.type}</p>`;

  if (stop.type === 'mc') {
    document.querySelectorAll('.q-opt-btn').forEach((btn, i) => {
      btn.addEventListener('click', () => selectMC(i));
    });
  } else if (stop.type === 'tf') {
    document.querySelectorAll('.q-tf-btn').forEach(btn => {
      btn.addEventListener('click', () => selectTF(btn.dataset.val === 'true'));
    });
  } else if (stop.type === 'fill') {
    const inp = document.getElementById('q-fill-input');
    inp.addEventListener('input', () => {
      const cb = document.getElementById('q-check-btn');
      if (inp.value.trim()) { cb.disabled = false; cb.className = 'q-check-btn active'; }
      else                  { cb.disabled = true;  cb.className = 'q-check-btn'; }
    });
    inp.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !answered && inp.value.trim()) checkAnswer();
    });
  } else if (stop.type === 'eslestime') {
    totalPairs = stop.pairs.length;
    document.querySelectorAll('.q-match-left').forEach(btn => btn.addEventListener('click', () => selectMatchLeft(btn)));
    document.querySelectorAll('.q-match-right').forEach(btn => btn.addEventListener('click', () => selectMatchRight(btn)));
  }
}

/* ---- MC ---- */
function renderMC(stop) {
  const opts = stop.options || [];
  return `
    <div class="q-type-label">√áoktan Se√ßmeli <small style="opacity:.5;font-size:10px">(1-4 tu≈ülarƒ±)</small></div>
    <div class="q-question-text">${stop.question}</div>
    <div class="q-options-list">
      ${opts.map((o, i) => `
        <button class="q-opt-btn" data-i="${i}">
          <span class="q-opt-letter">${String.fromCharCode(65 + i)}</span>
          <span>${o}</span>
        </button>`).join('')}
    </div>`;
}

function selectMC(i) {
  if (answered) return;
  selectedAnswer = i;
  document.querySelectorAll('.q-opt-btn').forEach((btn, bi) => btn.classList.toggle('selected', bi === i));
  const cb = document.getElementById('q-check-btn');
  cb.disabled = false; cb.className = 'q-check-btn active';
}

/* ---- TF ---- */
function renderTF(stop) {
  return `
    <div class="q-type-label">Doƒüru / Yanlƒ±≈ü <small style="opacity:.5;font-size:10px">(T/F tu≈ülarƒ±)</small></div>
    <div class="q-question-text">${stop.statement}</div>
    <div class="q-tf-row">
      <button class="q-tf-btn" data-val="true"><span class="tf-icon">‚úÖ</span><span>Doƒüru</span></button>
      <button class="q-tf-btn" data-val="false"><span class="tf-icon">‚ùå</span><span>Yanlƒ±≈ü</span></button>
    </div>`;
}

function selectTF(val) {
  if (answered) return;
  selectedAnswer = val;
  document.querySelectorAll('.q-tf-btn').forEach(btn => {
    btn.classList.toggle('selected', (btn.dataset.val === 'true') === val);
  });
  const cb = document.getElementById('q-check-btn');
  cb.disabled = false; cb.className = 'q-check-btn active';
}

/* ---- Fill ---- */
function renderFill(stop) {
  const template = (stop.template || '').replace('___', '<span class="q-fill-blank">___</span>');
  return `
    <div class="q-type-label">Bo≈üluk Doldur</div>
    <div class="q-fill-template">${template}</div>
    <input class="q-fill-input" id="q-fill-input" type="text"
           placeholder="Cevabƒ±nƒ± yaz..." autocomplete="off" autocorrect="off" spellcheck="false">`;
}

/* ---- Match ---- */
function renderMatch(stop) {
  const pairs = stop.pairs || [];
  const rightItems = pairs.map((p, i) => ({ text: p[1], pairIdx: i }));
  rightItems.sort(() => Math.random() - 0.5);
  return `
    <div class="q-type-label">E≈üle≈ütirme</div>
    <div class="q-question-text">Sol ve saƒü kolonlarƒ± e≈üle≈ütir</div>
    <div class="q-match-hint">Soldan bir √∂ƒüe se√ß, sonra saƒüdan e≈üle≈ütiƒüini se√ß.</div>
    <div class="q-match-area">
      ${pairs.map((p, i) => `
        <div class="q-match-row" id="match-row-${i}">
          <button class="q-match-left" data-pair="${i}">${p[0]}</button>
          <div class="q-match-arrow">‚Üí</div>
          <button class="q-match-right" data-pair="${i}" data-actual="${rightItems[i].pairIdx}">${rightItems[i].text}</button>
        </div>`).join('')}
    </div>`;
}

function selectMatchLeft(btn) {
  if (answered || btn.classList.contains('matched')) return;
  document.querySelectorAll('.q-match-left').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedMatchLeft = btn;
}

function selectMatchRight(btn) {
  if (!selectedMatchLeft || answered || btn.classList.contains('matched')) return;
  const leftPair = parseInt(selectedMatchLeft.dataset.pair);
  const rightActual = parseInt(btn.dataset.actual);
  if (leftPair === rightActual) {
    selectedMatchLeft.classList.remove('selected');
    selectedMatchLeft.classList.add('matched');
    btn.classList.add('matched');
    selectedMatchLeft.disabled = true;
    btn.disabled = true;
    selectedMatchLeft = null;
    matchedPairs++;
    if (matchedPairs === totalPairs) {
      const cb = document.getElementById('q-check-btn');
      cb.disabled = false; cb.className = 'q-check-btn active'; cb.textContent = 'Tamamlandƒ± ‚úì';
    }
  } else {
    btn.classList.add('wrong');
    selectedMatchLeft.classList.remove('selected');
    setTimeout(() => btn.classList.remove('wrong'), 600);
    selectedMatchLeft = null;
    state.lives = Math.max(0, state.lives - 1);
    saveState();
    flashXP('‚àí‚ù§Ô∏è');
    const hp = Math.max(0, state.lives);
    document.getElementById('q-hearts-disp').textContent = '‚ù§Ô∏è'.repeat(hp) + 'üñ§'.repeat(Math.max(0, 5 - hp));
    if (state.lives <= 0) setTimeout(() => showScreen('nolives'), 1000);
  }
}

/* ============================================================
   CHECK ANSWER
   ============================================================ */
function checkAnswer() {
  if (answered) return;
  const stop = currentStops[currentStopIdx];
  if (!stop) return;
  answered = true;
  sessionTotal++;

  let isCorrect = false;

  if (stop.type === 'mc') {
    if (selectedAnswer === null) { answered = false; return; }
    isCorrect = selectedAnswer === stop.correct;
    document.querySelectorAll('.q-opt-btn').forEach((btn, i) => {
      btn.disabled = true;
      if (i === stop.correct) btn.classList.add('correct');
      else if (i === selectedAnswer && !isCorrect) btn.classList.add('wrong');
    });
  } else if (stop.type === 'tf') {
    if (selectedAnswer === null) { answered = false; return; }
    isCorrect = selectedAnswer === stop.correct;
    document.querySelectorAll('.q-tf-btn').forEach(btn => {
      btn.disabled = true;
      const v = btn.dataset.val === 'true';
      if (v === stop.correct) btn.classList.add('correct');
      else if (v === selectedAnswer && !isCorrect) btn.classList.add('wrong');
    });
  } else if (stop.type === 'fill') {
    const inp = document.getElementById('q-fill-input');
    if (!inp || !inp.value.trim()) { answered = false; return; }
    inp.disabled = true;
    const userVal = inp.value.trim().toLowerCase().replace(/[^a-z0-9ƒü√º≈üƒ±√∂√ß√¢√Æ/_-]/gi, '');
    const correctVal = (stop.answer || '').toLowerCase().replace(/[^a-z0-9ƒü√º≈üƒ±√∂√ß√¢√Æ/_-]/gi, '');
    isCorrect = userVal === correctVal;
    inp.classList.add(isCorrect ? 'correct' : 'wrong');
  } else if (stop.type === 'eslestime') {
    isCorrect = matchedPairs === totalPairs;
  }

  const checkBtn = document.getElementById('q-check-btn');
  checkBtn.disabled = true;
  checkBtn.className = 'q-check-btn';

  if (isCorrect) {
    sessionCorrect++;
    state.xp += 10;
    sessionXP += 10;
    state.dailyGoal.xp = (state.dailyGoal.xp || 0) + 10;
    state.currentCombo = (state.currentCombo || 0) + 1;
    const combo = state.currentCombo;
    let bonus = 0;
    if (combo >= 3) {
      bonus = Math.min(combo, 12);
      state.xp += bonus;
      sessionXP += bonus;
      state.dailyGoal.xp += bonus;
      playComboSound();
    } else {
      playCorrect();
    }
    mascotReact('happy');
    flashXP(combo >= 3 ? `üî• ${combo}x Combo! +${10 + bonus} XP` : '+10 XP ‚≠ê');
    checkAchievements({ combo });
  } else {
    sessionErrors++;
    state.lives = Math.max(0, state.lives - 1);
    state.currentCombo = 0;
    playWrong();
    mascotReact('sad');
    // Shake
    const body = document.getElementById('q-body');
    if (body) { body.classList.remove('shaking'); void body.offsetWidth; body.classList.add('shaking'); }
    if (state.lives <= 0) {
      saveState();
      setTimeout(() => showScreen('nolives'), 1500);
    }
  }

  saveState();
  checkAchievements({});
  showFeedbackPanel(isCorrect, stop);
}

/* ============================================================
   FEEDBACK PANEL
   ============================================================ */
function showFeedbackPanel(isCorrect, stop) {
  const panel = document.getElementById('feedback-panel');
  const title = document.getElementById('fb-title');
  const correctAns = document.getElementById('fb-correct-ans');
  const explanation = document.getElementById('fb-explanation');
  const btn = document.getElementById('fb-btn');

  const combo = state.currentCombo;
  const comboHtml = (isCorrect && combo >= 3) ? `<span class="feedback-combo">üî• ${combo}x</span>` : '';

  panel.className = 'feedback-panel ' + (isCorrect ? 'correct' : 'wrong');
  title.innerHTML = (isCorrect ? 'üéâ Harika!' : 'üò¢ Doƒüru deƒüil') + comboHtml;

  if (!isCorrect && stop) {
    let correct = '';
    if (stop.type === 'mc' && stop.options) correct = stop.options[stop.correct];
    else if (stop.type === 'tf') correct = stop.correct ? 'Doƒüru ‚úÖ' : 'Yanlƒ±≈ü ‚ùå';
    else if (stop.type === 'fill') correct = stop.answer;
    if (correct) {
      correctAns.style.display = 'block';
      correctAns.textContent = 'Doƒüru cevap: ' + correct;
    } else {
      correctAns.style.display = 'none';
    }
  } else {
    correctAns.style.display = 'none';
  }

  explanation.textContent = (stop && stop.explanation) ? stop.explanation : '';
  btn.innerHTML = (isCorrect ? 'DEVAM ‚Üí' : 'TAMAM') + ' <small style="opacity:.5;font-size:12px">(Enter)</small>';

  setTimeout(() => panel.classList.add('show'), 50);
}

function hideFeedback() {
  const panel = document.getElementById('feedback-panel');
  if (panel) panel.classList.remove('show');
}

/* ============================================================
   NEXT STOP / FINISH TOPIC
   ============================================================ */
function nextStop() {
  hideFeedback();
  currentStopIdx++;
  if (currentStopIdx >= currentStops.length) finishTopic();
  else setTimeout(() => renderQuestionScreen(), 300);
}

function finishTopic() {
  const bonus = 25;
  state.xp += bonus;
  sessionXP += bonus;
  state.dailyGoal.xp = (state.dailyGoal.xp || 0) + bonus;
  state.streak = (state.streak || 0) + 1;

  const perfect   = sessionErrors === 0;
  const noMistakes = state.lives === 5 && sessionErrors === 0;

  if (!state.completedTopics.includes(currentTopicId)) {
    state.completedTopics.push(currentTopicId);
  }

  let unitComplete = false;
  const unit = CURRICULUM.units.find(u => u.id === currentUnitId);
  if (unit) {
    const allDone = unit.topics.every(t => state.completedTopics.includes(t.id));
    if (allDone && !state.completedUnits.includes(currentUnitId)) {
      state.completedUnits.push(currentUnitId);
      state.xp += 100;
      sessionXP += 100;
      unitComplete = true;
      launchConfetti();
    }
  }

  saveState();
  checkAchievements({ perfect, noMistakes });

  const lvl = getLevelInfo(state.xp);
  const acc = sessionTotal > 0 ? Math.round((sessionCorrect / sessionTotal) * 100) : 100;

  document.getElementById('comp-title').textContent = unitComplete ? 'üéä √únite Tamamlandƒ±!' : 'üèÜ Konu Tamamlandƒ±!';
  document.getElementById('comp-xp').textContent = '+' + sessionXP;
  document.getElementById('comp-acc').textContent = acc + '%';
  document.getElementById('comp-streak').textContent = state.streak;
  document.getElementById('comp-sub').textContent = sessionTotal > 0
    ? `${sessionCorrect}/${sessionTotal} soruyu doƒüru cevapladƒ±n!`
    : 'T√ºm sorularƒ± tamamladƒ±n!';
  document.getElementById('comp-level-label').textContent = lvl.emoji + ' ' + lvl.label + ' Seviyesin';

  playComplete();
  showScreen('completion');
}

function refillLives() {
  state.lives = 5;
  saveState();
  if (currentTopicId) startTopic(currentUnitId, currentTopicId);
  else showHome();
}

/* ============================================================
   MASCOT REACTIONS
   ============================================================ */
function mascotReact(type) {
  const el = document.getElementById('mascot-img');
  if (!el) return;
  el.style.transition = 'transform .2s, filter .2s';
  if (type === 'happy') {
    el.style.transform = 'scale(1.4)';
    el.style.filter = 'brightness(1.5)';
  } else {
    el.style.transform = 'rotate(-15deg)';
    el.style.filter = 'grayscale(0.6)';
  }
  setTimeout(() => { el.style.transform = ''; el.style.filter = ''; }, 600);
}

/* ============================================================
   XP FLASH
   ============================================================ */
function flashXP(text) {
  const el = document.createElement('div');
  el.className = 'xp-flash';
  el.textContent = text;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 950);
}

/* ============================================================
   TOAST
   ============================================================ */
function showToast(msg, dur = 2500) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), dur);
}

/* ============================================================
   CONFETTI
   ============================================================ */
function launchConfetti() {
  const colors = ['#58CC02', '#FF9600', '#FFD900', '#1CB0F6', '#FF4B4B', '#CE82FF'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.top = '-10px';
    el.style.background = colors[Math.floor(Math.random() * colors.length)];
    el.style.width  = (Math.random() * 8 + 6) + 'px';
    el.style.height = (Math.random() * 8 + 6) + 'px';
    el.style.borderRadius = Math.random() > .5 ? '50%' : '2px';
    el.style.animationDuration = (Math.random() * 2 + 2) + 's';
    el.style.animationDelay = (Math.random() * .8) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}

/* ============================================================
   TWITTER SHARE
   ============================================================ */
function shareTwitter() {
  const unit  = CURRICULUM?.units?.find(u => u.id === currentUnitId);
  const topic = unit?.topics?.find(t => t.id === currentTopicId);
  const lvl   = getLevelInfo(state.xp);
  const txt   = `${lvl.emoji} TechDuo'da "${topic?.title || 'bir konuyu'}" tamamladƒ±m! +${sessionXP} XP kazandƒ±m üéØ\n\nT√ºrk√ße teknoloji √∂ƒüreniyorum üáπüá∑ ‚Üí https://mahsumaktas.github.io/techduo/ #TechDuo #TeknolojiBilgisi`;
  window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(txt), '_blank');
}

/* ============================================================
   PLACEMENT TEST
   ============================================================ */
let placementStops = [];
let placementIdx = 0;
let placementCorrect = 0;
let placementAnswered = false;

function startPlacementTest() {
  if (!CURRICULUM) return;
  placementStops = [];
  CURRICULUM.units.slice(2).forEach(unit => {
    if (unit.topics && unit.topics.length > 0) {
      const topic = unit.topics[Math.floor(Math.random() * unit.topics.length)];
      if (topic.stops && topic.stops.length > 0) {
        const stop = topic.stops[Math.floor(Math.random() * topic.stops.length)];
        placementStops.push({ ...stop, _unitId: unit.id });
      }
    }
  });
  placementStops = placementStops.slice(0, 8);
  placementIdx = 0;
  placementCorrect = 0;
  placementAnswered = false;
  renderPlacementQuestion();
  showScreen('placement');
}

function renderPlacementQuestion() {
  const body = document.getElementById('placement-body');
  if (placementIdx >= placementStops.length) { showPlacementResult(); return; }
  const stop = placementStops[placementIdx];
  placementAnswered = false;
  const pct = Math.round((placementIdx / placementStops.length) * 100);

  let qHtml = '';
  if (stop.type === 'mc') {
    const opts = stop.options || [];
    qHtml = `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
      ${opts.map((o, i) => `<button class="q-opt-btn" data-i="${i}" onclick="checkPlacementMC(${i},${stop.correct})">
        <span class="q-opt-letter">${String.fromCharCode(65+i)}</span><span>${o}</span>
      </button>`).join('')}
    </div>`;
  } else if (stop.type === 'tf') {
    qHtml = `<div class="q-tf-row">
      <button class="q-tf-btn" onclick="checkPlacementTF(true,${stop.correct})"><span class="tf-icon">‚úÖ</span><span>Doƒüru</span></button>
      <button class="q-tf-btn" onclick="checkPlacementTF(false,${stop.correct})"><span class="tf-icon">‚ùå</span><span>Yanlƒ±≈ü</span></button>
    </div>`;
  } else {
    qHtml = `<button class="placement-skip-btn" onclick="nextPlacement()">Bu soruyu ge√ß ‚Üí</button>`;
  }

  body.innerHTML = `
    <div style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-light);margin-bottom:6px">
        <span>Soru ${placementIdx+1}/${placementStops.length}</span><span>${placementCorrect} doƒüru</span>
      </div>
      <div style="height:8px;background:var(--border);border-radius:5px;overflow:hidden">
        <div style="height:100%;background:var(--purple);border-radius:5px;width:${pct}%;transition:width .4s"></div>
      </div>
    </div>
    <div class="q-question-text" style="font-size:17px">${stop.question || stop.statement || ''}</div>
    ${qHtml}
    <button class="placement-skip-btn" onclick="nextPlacement()">Ge√ß ‚Üí</button>`;
}

function checkPlacementMC(selected, correct) {
  if (placementAnswered) return;
  placementAnswered = true;
  if (selected === correct) placementCorrect++;
  document.querySelectorAll('.q-opt-btn').forEach((btn, i) => {
    btn.disabled = true;
    if (i === correct) btn.classList.add('correct');
    else if (i === selected) btn.classList.add('wrong');
  });
  setTimeout(nextPlacement, 900);
}

function checkPlacementTF(userBool, correctBool) {
  if (placementAnswered) return;
  placementAnswered = true;
  if (userBool === (correctBool === true || correctBool === 'true')) placementCorrect++;
  setTimeout(nextPlacement, 700);
}

function nextPlacement() { placementIdx++; renderPlacementQuestion(); }

function showPlacementResult() {
  const score = placementCorrect;
  const total = placementStops.length;
  let icon, title, sub, action;
  if (score <= 2) {
    icon = 'üå±'; title = 'Temel Seviye';
    sub = 'Harika! Ba≈ülangƒ±√ßtan ilerleyelim. Her ≈üeyi √∂ƒüreneceksin!';
    action = `<button class="placement-result-btn" onclick="showHome()">üöÄ Ba≈ütan Ba≈üla</button>`;
  } else if (score <= 5) {
    icon = 'üìö'; title = 'Orta Seviye';
    sub = `${score}/${total} doƒüru! 3. √ºniteden devam edebilirsin.`;
    action = `<button class="placement-result-btn" onclick="skipToUnit(2)">‚è© 3. √úniteden Ba≈üla</button>`;
  } else {
    icon = 'üí°'; title = 'ƒ∞leri Seviye';
    sub = `Etkileyici! ${score}/${total} doƒüru. 5. √ºniteden devam et.`;
    action = `<button class="placement-result-btn" onclick="skipToUnit(4)">‚ö° 5. √úniteden Ba≈üla</button>`;
  }
  document.getElementById('placement-body').innerHTML = `
    <div class="placement-result">
      <div class="placement-result-icon">${icon}</div>
      <div class="placement-result-title">${title}</div>
      <div class="placement-result-sub">${sub}</div>
      ${action}
      <button class="placement-skip-btn" onclick="showHome()">‚Üê Ana Sayfaya D√∂n</button>
    </div>`;
}

function skipToUnit(targetIdx) {
  if (!CURRICULUM) return showHome();
  CURRICULUM.units.slice(0, targetIdx).forEach(unit => {
    unit.topics.forEach(t => { if (!state.completedTopics.includes(t.id)) state.completedTopics.push(t.id); });
    if (!state.completedUnits.includes(unit.id)) state.completedUnits.push(unit.id);
  });
  saveState();
  showToast('‚è© ƒ∞leri atlandƒ±!');
  setTimeout(() => showHome(), 500);
}

/* ============================================================
   KEYBOARD SHORTCUTS
   ============================================================ */
document.addEventListener('keydown', e => {
  const screen = document.querySelector('.screen.active');
  if (!screen || screen.id !== 'screen-question') return;
  const key = e.key.toLowerCase();
  const stop = currentStops[currentStopIdx];
  if (!stop) return;

  if (!answered) {
    if (stop.type === 'mc') {
      const map = { '1': 0, '2': 1, '3': 2, '4': 3 };
      if (map[e.key] !== undefined) { e.preventDefault(); selectMC(map[e.key]); }
      if (key === 'enter') {
        e.preventDefault();
        const cb = document.getElementById('q-check-btn');
        if (cb && !cb.disabled) checkAnswer();
      }
    } else if (stop.type === 'tf') {
      if (key === 't' || key === '1') { e.preventDefault(); document.querySelector('.q-tf-btn[data-val="true"]')?.click(); }
      if (key === 'f' || key === '2') { e.preventDefault(); document.querySelector('.q-tf-btn[data-val="false"]')?.click(); }
    } else if (stop.type === 'fill') {
      if (key === 'enter') { e.preventDefault(); checkAnswer(); }
    }
  } else {
    if (key === 'enter' || key === ' ') { e.preventDefault(); nextStop(); }
  }
});

/* ============================================================
   INIT
   ============================================================ */
loadState();
updateHUD();
showScreen('splash');

fetch('curriculum.json')
  .then(r => r.json())
  .then(data => {
    CURRICULUM = data;
  })
  .catch(err => {
    const ul = document.getElementById('unit-list');
    if (ul) ul.innerHTML = `<p style="color:var(--red);padding:20px">curriculum.json y√ºklenemedi: ${err.message}</p>`;
  });
</script>
</body>
</html>
